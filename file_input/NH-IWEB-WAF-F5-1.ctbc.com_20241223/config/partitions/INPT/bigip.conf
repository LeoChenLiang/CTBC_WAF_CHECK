#TMSH-VERSION: 17.1.1.3

apm client-packaging /INPT/client-packaging { }
apm resource sandbox /INPT/citrix-client-package {
    base-uri /INPT/public/citrix
    description "Sandbox for Citrix client package files"
}
apm resource sandbox /INPT/hosted-content {
    base-uri /INPT/public/share
    description "Sandbox for static contents"
}
asm policy /INPT/SP_INPT {
    active
    encoding utf-8
}
ltm node /INPT/10.243.136.139 {
    address 10.243.136.139
}
ltm node /INPT/10.243.136.140 {
    address 10.243.136.140
}
ltm node /INPT/10.243.136.141 {
    address 10.243.136.141
}
ltm node /INPT/10.248.29.53 {
    address 10.248.29.53
}
ltm node /INPT/10.248.29.59 {
    address 10.248.29.59
}
ltm node /INPT/10.248.29.61 {
    address 10.248.29.61
}
ltm node /INPT/10.248.29.62 {
    address 10.248.29.62
}
ltm node /INPT/10.248.73.106 {
    address 10.248.73.106
}
ltm node /INPT/10.248.73.107 {
    address 10.248.73.107
}
ltm policy /INPT/asm_auto_l7_policy__VS_INPT_EXT_175.184.240.192_80 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /INPT/SP_INPT
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /INPT/asm_auto_l7_policy__VS_INPT_EXT_175.184.240.192_443 {
    controls { asm }
    requires { http }
    rules {
        "Bypass URL" {
            actions {
                0 {
                    asm
                    disable
                }
            }
            conditions {
                0 {
                    http-uri
                    contains
                    values { /PT/api/loguploader /ptapp/api/loguploader }
                }
            }
        }
        default {
            actions {
                0 {
                    asm
                    enable
                    policy /INPT/SP_INPT
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /INPT/asm_auto_l7_policy__VS_INPT_Intra_192.168.212.20_80 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /INPT/SP_INPT
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /INPT/asm_auto_l7_policy__VS_INPT_Intra_192.168.212.20_443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /INPT/SP_INPT
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /INPT/asm_auto_l7_policy__VS_INPT_Intra_192.168.212.20_8080 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                0 {
                    asm
                    enable
                    policy /INPT/SP_INPT
                }
            }
        }
    }
    strategy /Common/first-match
}
ltm policy /INPT/asm_auto_l7_policy__VS_INPT_Intra_192.168.212.20_8443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /INPT/SP_INPT
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm pool /INPT/POOL_INPT_APP_WEB {
    members {
        /INPT/10.248.29.53:38080 {
            address 10.248.29.53
        }
        /INPT/10.248.29.62:38080 {
            address 10.248.29.62
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_GW {
    monitor /Common/tcp
}
ltm pool /INPT/POOL_INPT_IMAGE {
    description Image
    members {
        /INPT/10.243.136.139:8086 {
            address 10.243.136.139
        }
        /INPT/10.243.136.140:8086 {
            address 10.243.136.140
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_IMP {
    members {
        /INPT/10.248.73.106:9280 {
            address 10.248.73.106
            monitor /Common/tcp
        }
        /INPT/10.248.73.107:9280 {
            address 10.248.73.107
            monitor /Common/tcp
        }
    }
    monitor /Common/tcp
}
ltm pool /INPT/POOL_INPT_MFP_AP {
    members {
        /INPT/10.248.29.59:9081 {
            address 10.248.29.59
        }
        /INPT/10.248.29.61:9081 {
            address 10.248.29.61
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_MFP_AP_DU {
    members {
        /INPT/10.248.29.53:9081 {
            address 10.248.29.53
        }
        /INPT/10.248.29.62:9081 {
            address 10.248.29.62
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_MFP_AP_SPLAP0007INPT {
    members {
        /INPT/10.248.29.61:9081 {
            address 10.248.29.61
            session user-disabled
            state user-down
        }
    }
    monitor /Common/tcp
}
ltm pool /INPT/POOL_INPT_NGINX {
    members {
        /INPT/10.248.29.53:9081 {
            address 10.248.29.53
            monitor /Common/tcp
        }
        /INPT/10.248.29.62:9081 {
            address 10.248.29.62
            monitor /Common/tcp
        }
    }
    monitor /Common/tcp
}
ltm pool /INPT/POOL_INPT_OPENAPI_8080 {
    members {
        /INPT/10.243.136.139:8080 {
            address 10.243.136.139
        }
        /INPT/10.243.136.140:8080 {
            address 10.243.136.140
        }
    }
    monitor /Common/tcp
}
ltm pool /INPT/POOL_INPT_PORTAL_5080 {
    members {
        /INPT/10.243.136.141:5080 {
            address 10.243.136.141
            monitor /Common/tcp
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_TUIPAYMT2 {
    members {
        /INPT/10.243.136.139:8190 {
            address 10.243.136.139
        }
        /INPT/10.243.136.140:8190 {
            address 10.243.136.140
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_TUIPAYMT2_EXT {
    members {
        /INPT/10.243.136.139:8190 {
            address 10.243.136.139
        }
        /INPT/10.243.136.140:8190 {
            address 10.243.136.140
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_WEB_8083 {
    description "New Web AP Server"
    members {
        /INPT/10.243.136.139:7280 {
            address 10.243.136.139
            monitor /Common/tcp
        }
        /INPT/10.243.136.139:7281 {
            address 10.243.136.139
            monitor /Common/tcp
        }
        /INPT/10.243.136.139:7283 {
            address 10.243.136.139
            monitor /Common/tcp
        }
        /INPT/10.243.136.139:7284 {
            address 10.243.136.139
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.139:8083 {
            address 10.243.136.139
            monitor /Common/tcp
        }
        /INPT/10.243.136.140:7280 {
            address 10.243.136.140
            monitor /Common/tcp
        }
        /INPT/10.243.136.140:7281 {
            address 10.243.136.140
            monitor /Common/tcp
        }
        /INPT/10.243.136.140:7283 {
            address 10.243.136.140
            monitor /Common/tcp
        }
        /INPT/10.243.136.140:7284 {
            address 10.243.136.140
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.140:8083 {
            address 10.243.136.140
            monitor /Common/tcp
        }
        /INPT/10.243.136.141:7280 {
            address 10.243.136.141
            monitor /Common/tcp
        }
        /INPT/10.243.136.141:7281 {
            address 10.243.136.141
            monitor /Common/tcp
        }
        /INPT/10.243.136.141:7283 {
            address 10.243.136.141
            monitor /Common/tcp
        }
        /INPT/10.243.136.141:7284 {
            address 10.243.136.141
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.141:8083 {
            address 10.243.136.141
            monitor /Common/tcp
        }
    }
    monitor /Common/http
}
ltm pool /INPT/POOL_INPT_WEB_8083_INTRA {
    description WEB內部IRULE
    members {
        /INPT/10.243.136.139:7280 {
            address 10.243.136.139
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.139:7284 {
            address 10.243.136.139
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.139:8083 {
            address 10.243.136.139
            monitor /Common/tcp
            session user-disabled
        }
        /INPT/10.243.136.140:7283 {
            address 10.243.136.140
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.140:7284 {
            address 10.243.136.140
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.140:8083 {
            address 10.243.136.140
            monitor /Common/tcp
            session user-disabled
        }
        /INPT/10.243.136.141:7280 {
            address 10.243.136.141
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.141:7281 {
            address 10.243.136.141
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.141:7283 {
            address 10.243.136.141
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.141:7284 {
            address 10.243.136.141
            monitor /Common/tcp
            session user-disabled
            state user-down
        }
        /INPT/10.243.136.141:8083 {
            address 10.243.136.141
            monitor /Common/tcp
        }
    }
    monitor /Common/http
}
ltm rule /INPT/iRule_Dispatch_INPT_Allowed_NewPlatform {
when RULE_INIT {  
    set ::ma_down_inpt "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#28858;&#20102;&#25552;&#20379;&#26356;&#22909;&#30340;&#26381;&#21209;&#65292;&#26412;&#34892;&#30446;&#21069;&#27491;&#22312;&#36914;&#34892;&#30828;&#39636;&#21319;&#32026;&#20316;&#26989;&#12290; </p><p&#22914;&#20316;&#26989;&#38918;&#21033;&#26371;&#25552;&#26089;&#24674;&#24489;&#26381;&#21209;&#12290;&#36896;&#25104;&#24744;&#30340;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351; &#25964;&#21855;</p></body></html>"
    set ::ma_content_inpt "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#28858;&#20102;&#25552;&#20379;&#26356;&#22909;&#30340;&#26381;&#21209;&#65292;&#26412;&#34892;&#30446;&#21069;&#27491;&#22312;&#36914;&#34892;&#30828;&#39636;&#21319;&#32026;&#20316;&#26989;&#12290; </p><p> &#22914;&#20316;&#26989;&#38918;&#21033;&#26371;&#25552;&#26089;&#24674;&#24489;&#26381;&#21209;&#12290;&#36896;&#25104;&#24744;&#30340;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351; &#25964;&#21855;</p></body></html>"
    set ::update_inpt "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><script charset='UFT-8'>alert('i\u7e73\u8cbbAPP\u5168\u65b0\u6539\u7248\u518d\u51fa\u767c\uff0c\u8acb\u66f4\u65b0APP\u4ee5\u4eab\u6709\u6700\u65b0\u670d\u52d9\u9ad4\u9a57\uff0c\u8b1d\u8b1d');</script></html>"
}
when HTTP_REQUEST {
    set referer [string tolower [HTTP::header value "Referer"]]
    set reqURI [HTTP::uri];
    if { [HTTP::has_responded] } { return };
    if { [HTTP::uri] contains "/favicon.ico" }{
        HTTP::uri [string map {"/favicon.ico" "/web/favicon.ico"} [HTTP::uri]]
    }
	HTTP::header insert X-Forwarded-Proto "https"

        if { [HTTP::uri] starts_with "/ipaymentGW" }{

                if {[HTTP::uri] contains "/web/main/inputPayment.action"}{
                    HTTP::redirect "/web/tuition"
                }elseif {([HTTP::uri] contains "/web/main/inputPaymentByPost.action")}{
                    HTTP::respond 307 Location "https://www.27608818.com/ipaymentGW/iframe/confirmPaymentInfo.do"
                }elseif {([HTTP::uri] contains "/iframe/confirmPaymentInfo.do")}{
                    snat automap
                    pool POOL_INPT_IMAGE
                }elseif {([HTTP::uri] contains "/web/main/mainIndex.action")}{
                     HTTP::redirect "https://www.27608818.com/web/"
                }elseif  {([HTTP::uri] contains "/tes/payTes.do")}{
                    HTTP::uri [string map {"/ipaymentGW/tes/payTes.do" "/web/processTesPost"} [HTTP::uri]]
                    HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
                }elseif {([HTTP::uri] starts_with "/ipaymentGW/web/life/creditcardLife/mCreditcardLifePayment") || ([HTTP::uri] starts_with "/ipaymentGW/web/life/creditcardLife/creditcardLifePayment")}{
                    HTTP::redirect "/web/ccfee"
                }elseif {([HTTP::uri] starts_with "/ipaymentGW/i.html")}{
                    HTTP::redirect "/appweb/redirect.html"
                }elseif {([HTTP::uri] starts_with "/ipaymentGW/mobileWeb/index")}{
                    HTTP::redirect "/web"
                }elseif  {([HTTP::uri] starts_with "/ipaymentGW/qrcode.do")}{
                  if { ([HTTP::uri] contains "txn=")}{
                    snat automap
                    pool POOL_INPT_GW
                  } else {
                    #HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
                    #HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
                    if  { ([HTTP::method] eq "POST") and ([HTTP::uri] starts_with "/ipaymentGW/qrcode.do")}{      
                        HTTP::collect [HTTP::header Content-Length]          
                    } else {
                        HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
                        HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]" 
                    }
                  }

                }elseif {([HTTP::uri] starts_with "/ipaymentGW/api")}{
                    snat automap
                    pool POOL_INPT_GW
                #HTTP::respond 200 content $::update_inpt
                }else {
                    HTTP::respond 200 content $::update_inpt
                }

                #elseif  {([HTTP::uri] starts_with "/ipaymentGW/qrcode.do")}{
                 #   HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
                  #  HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
                #}

        } elseif { ([HTTP::uri] starts_with "/IMP/directupdate/download/")}{
        	snat automap
        	pool POOL_INPT_NGINX
        } elseif { ([HTTP::uri] starts_with "/IMP")}{
        	snat automap
        	pool POOL_INPT_IMP
        } elseif {[HTTP::uri] starts_with "/tuipaymtUPOP/pages/unionPay/returnMessage.faces" }{
         HTTP::uri [string map {"/tuipaymtUPOP/pages/unionPay/returnMessage.faces" "/web/npgCallBackToRedirect"} [HTTP::uri]]
         HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
        } elseif {[HTTP::uri] starts_with "/tuipaymtUPOP/callBackService" }{
           HTTP::uri [string map {"/tuipaymtUPOP/callBackService" "/web/npgCallBackToProcess"} [HTTP::uri]]
           snat automap
           pool POOL_INPT_WEB_8083_INTRA
        } elseif {[HTTP::uri] starts_with "/tuipaymtUPOP/pages/unionPay/query.faces" }{
           HTTP::uri [string map {"/tuipaymtUPOP/pages/unionPay/query.faces" "/web/inputTuitionUpopPayment"} [HTTP::uri]]
           snat automap
           pool POOL_INPT_WEB_8083_INTRA
        } elseif {([HTTP::uri] starts_with "/tuipaymt/index.jsp") || ([HTTP::uri] contains "/tuipaymt/student")}
        {
            HTTP::redirect "https://www.27608818.com/web/"
            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } elseif {[HTTP::uri] starts_with "/tuipaymtAdmin" }
        {
            #portal intranet only should before tuipaymt
            HTTP::header replace "X-Forwarded-For" "192.168.212.15"
            snat automap
            pool POOL_INPT_PORTAL_5080
            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } elseif {[HTTP::uri] starts_with "/tuipaymt2" }
        {

                snat automap
                pool POOL_INPT_TUIPAYMT2
            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        }  elseif {[HTTP::uri] starts_with "/tuipaymt" }
        {
            if {[HTTP::uri] starts_with "/tuipaymt/taichungPark/browser/parkgFeeQuery.faces" }{
               HTTP::uri [string map {"/tuipaymt/taichungPark/browser/parkgFeeQuery.faces" "/web/parkingbill?transType=02"} [HTTP::uri]]
               snat automap
               pool POOL_INPT_WEB_8083
            } elseif {[HTTP::uri] starts_with "/tuipaymt/taichungPark/webview/parkgFeeQuery.faces" }{
               HTTP::uri [string map {"/tuipaymt/taichungPark/webview/parkgFeeQuery.faces" "/web/parkingbill?transType=02"} [HTTP::uri]]
               snat automap
               pool POOL_INPT_WEB_8083
            } elseif {[HTTP::uri] starts_with "/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces" }{
              HTTP::uri [string map {"/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces" "/web/taichungFormPostRedirect"} [HTTP::uri]]
              snat automap
              pool POOL_INPT_WEB_8083
                  # snat automap
                  # pool POOL_INPT_GW
          #  } elseif { ([HTTP::uri] starts_with "/tuipaymt/taichungPark") ||  ([HTTP::uri] starts_with "/tuipaymt/css") || ([HTTP::uri] starts_with "/tuipaymt/tui-asset") }{
               #HTTP::uri [string map {"/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces" "/web/taichungFormPostRedirect"} [HTTP::uri]]
           #    snat automap
           #    pool POOL_INPT_GW
               #pool POOL_INPT_WEB_8083_INTRA
            } elseif {[HTTP::uri] starts_with "/tuipaymt/webApi" }{
                HTTP::uri [string map {"/tuipaymt/webApi/webApiFacade.faces" "/tuipaymt2/webApi/webApiFacade.faces"} [HTTP::uri]]
                snat automap
                pool POOL_INPT_TUIPAYMT2_EXT
            } else {
                HTTP::redirect "https://www.27608818.com/tuipaymt2/"
            }



            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } elseif { [HTTP::uri] starts_with "/api"  }
    {
        snat automap
        pool POOL_INPT_OPENAPI_8080
        #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    } elseif { [HTTP::uri] starts_with "/web" } {

   #  if {[HTTP::uri] starts_with "/web/parkingbill?transType=02" }{
           #HTTP::uri [string map {"/web/parkingbill?transType=02" "/tuipaymt/taichungPark/browser/parkgFeeQuery.faces"} [HTTP::uri]]
      #     snat automap
      #     pool POOL_INPT_WEB_8083_INTRA
      #  } elseif {[HTTP::uri] starts_with "/web/taichungFormPostRedirect" }{
           #HTTP::uri [string map {"/web/taichungFormPostRedirect" "/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces"} [HTTP::uri]]
       #    snat automap
       #    pool POOL_INPT_WEB_8083_INTRA
        #} else {
             snat automap
             pool POOL_INPT_WEB_8083_INTRA
       # }
      #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    } elseif { [HTTP::uri] starts_with "/source" } {

      snat automap
      pool POOL_INPT_IMAGE
      #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    } elseif { [HTTP::uri] starts_with "/.well-known" } {

      snat automap
      pool POOL_INPT_APP_WEB
    } elseif { ([HTTP::uri] starts_with "/appweb")}{
      snat automap
      pool POOL_INPT_APP_WEB
    } elseif { ([HTTP::uri] starts_with "/PTAPP")}{
      if { ([HTTP::uri] starts_with "/PTAPP/api/directupdate")}{
        snat automap
        pool POOL_INPT_MFP_AP_DU
      } else {
        snat automap
        pool POOL_INPT_MFP_AP
      }
    } elseif {[HTTP::uri] starts_with "/ipaymentAdmin"}{
           #portal intranet only
           HTTP::header replace "X-Forwarded-For" "192.168.212.15"
           snat automap
            pool POOL_INPT_PORTAL_5080
    } elseif {([HTTP::uri] starts_with "/portal")} {
         #portal intranet only
        HTTP::redirect "https://10.243.136.141:9088/portal/"
        #  HTTP::header replace "X-Forwarded-For" "192.168.212.15"
        #     snat automap
        #  	pool POOL_INPT_PORTAL_9088
    } else {
                HTTP::redirect "https://www.27608818.com/web/"
            #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    }
}


# when HTTP_REQUEST_DATA {
#     HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
#     HTTP::respond 302 Location "https://www.27608818.com[HTTP::uri]?vData=[findstr [HTTP::payload] "vData=" 6 &]"
# }


when HTTP_RESPONSE {
    set module [HTTP::header value "module-name"]


    HTTP::header remove Server
    foreach header_name [HTTP::header names] {
       #X-Frame-Options
       #&#20027;&#27231;&#23553;&#21253;&#27161;&#38957;&#36039;&#35338;&#27945;&#28431;&#20027;&#27231;&#12289;&#22871;&#20214;&#29256;&#26412; X-Powered-By
       #X-&#38283;&#38957;&#30340;&#37117;&#26371;&#34987;&#31227;&#25481;
       if {[string match -nocase X-* $header_name]}{
           if { ($header_name starts_with "x-auth-token")}{
           } else {
                HTTP::header remove $header_name
           }
       }
    }

    #iRule_dispatch_setCookie_HTTP_HTTPS_only &#24050;&#35373;
    #HTTP::header insert "X-Frame-Options" "SAMEORIGIN"
    HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubDomains"
    HTTP::header insert "X-Content-Type-Options" "nosniff"
    HTTP::header insert "X-Forwarded-Proto" "https"
    HTTP::header insert "X-XSS-Protection" "1; mode=block"
    HTTP::header remove "permissions-policy"
    HTTP::header insert "permissions-policy" "camera=(), geolocation=(), microphone=()"
    HTTP::header insert "Content-Security-Policy"  "default-src 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.google-analytics.com https://ssl.google-analytics.com https://www.googleadservices.com https://googleads.g.doubleclick.net https://*.googletagmanager.com https://tagmanager.google.com; style-src 'self' 'unsafe-inline' https://tagmanager.google.com https://fonts.googleapis.com; img-src 'self' data: https://ipayment.ctbcbank.com https://www.google.com https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw https://ssl.gstatic.com https://www.gstatic.com; connect-src 'self' https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw; font-src 'self' data: https://fonts.gstatic.com; frame-src 'self' https://bid.g.doubleclick.net; media-src 'self' data:;"

 #   if {($reqURI starts_with "/web/freego")} {
        #HTTP::redirect "/web/"
 #       HTTP::header remove "permissions-policy"
 #       HTTP::header insert "permissions-policy" "camera=(), geolocation=(), microphone=(self)"
 #       HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; media-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
 #   } elseif {($reqURI starts_with "/web/")}{
		#HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' 'unsafe-inline' https://tagmanager.google.com https://*.googletagmanager.com https://www.google-analytics.com https://ssl.google-analytics.com; img-src 'self' data: www.googletagmanager.com https://*.ctbcbank.com https://*.google-analytics.com https://*.googletagmanager.com https://googleads.g.doubleclick.net https://www.google.com https://www.google.com.tw; connect-src 'self' https://*.google-analytics.com https://analytics.google.com https://*.analytics.google.com https://*.googletagmanager.com https://*.g.doubleclick.net;"
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} elseif {($reqURI starts_with "/tuipaymt2/")}{
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} elseif {($reqURI starts_with "/ipaymentGW/")}{
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} elseif {($reqURI starts_with "/source/img/")}{
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	}  else {
        #Origin
 #       HTTP::header insert "Content-Security-Policy" "default-src * data: blob: ws: wss: gap://ready file://* 'unsafe-inline' 'unsafe-eval';script-src * 'unsafe-inline' 'unsafe-eval' 'unsafe-inline';connect-src * 'unsafe-inline';img-src * data: blob: 'unsafe-inline';frame-src * data: blob:;style-src * 'unsafe-inline';frame-ancestors 'self'"   
  #  }      
    HTTP::header remove "Cache-Control"
    HTTP::header insert "Cache-Control" "no-store, max-age=0"
    HTTP::header insert "Referrer-Policy" "strict-origin-when-cross-origin"
    if { ([HTTP::header value Content-Type] contains "image/jpeg") or ([HTTP::header value Content-Type] contains "image/png") or ([HTTP::header value Content-Type] contains "text/javascript") or ([HTTP::header value Content-Type] contains "text/css") } {
       #if { [HTTP::header Content-Length] > 300 } { 
             #image ad use cache control to reduce network access
         HTTP::header remove "Cache-Control"
         HTTP::header insert "Cache-Control" "max-age=600"
       #}
    }
    if {  ($reqURI starts_with "/PTAPP")  || ($reqURI starts_with "/appweb") || ($reqURI starts_with "/IMP")} {
        #MFP don't redirect fail status to RWD

    } else {
           if { ([HTTP::status] == 400 ) || ([HTTP::status] == 401 ) || ([HTTP::status] == 404 )|| ([HTTP::status] == 405 ) || ([HTTP::status] == 407 ) || ([HTTP::status] == 417 ) || [HTTP::status] == 500 || ([HTTP::status] == 503 )} {
                if {($reqURI starts_with "/web/freego")} {
                  HTTP::redirect "/web/freego"
                }else {
                    HTTP::redirect "/web/"
                }
            }
   }
}

when HTTP_RESPONSE_RELEASE priority 900 {
  if { [HTTP::header count {Set-Cookie} ] > 0 } {
        set COOKIE_VAL [HTTP::header values {Set-Cookie}] 
        HTTP::header remove {Set-Cookie} 
        foreach COOKIE_NAME $COOKIE_VAL {
            if { !([string match -nocase {*SameSite=*} ${COOKIE_NAME}] || [string match -nocase {*Secure*} ${COOKIE_NAME}] || [string match -nocase {*HTTPOnly*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax; Secure; HTTPOnly;" 
            } elseif { !([string match -nocase {*SameSite=*} ${COOKIE_NAME}] || [string match -nocase {*Secure*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax; Secure;"
            } elseif { !([string match -nocase {*SameSite=*} ${COOKIE_NAME}] || [string match -nocase {*HTTPOnly*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax; HTTPOnly;" 
            } elseif { !([string match -nocase {*Secure*} ${COOKIE_NAME}] || [string match -nocase {*HTTPOnly*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; Secure; HTTPOnly;"
            } else {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax;"
            }
        }
    } else {
        HTTP::header replace Set-Cookie "pt=secure; SameSite=Lax; Path=/; Secure; HTTPOnly"
        HTTP::cookie secure "pt" enable
        HTTP::cookie httponly "pt" enable
    }
}

when HTTP_RESPONSE_RELEASE {
  if { !([HTTP::header exists "Strict-Transport-Security"])} {
    HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubDomains"
  }
}
when LB_FAILED {
    if {([HTTP::uri] starts_with "/PTAPP") || ([HTTP::uri] starts_with "/IMP")}{
        #MFP don't redirect fail status to RWD
    } else {
        HTTP::respond 200 content $::ma_content_inpt
    } 
}
}
ltm rule /INPT/iRule_Dispatch_INPT_NAP_NewPlatform {
when RULE_INIT {  
    set ::ma_down_inpt "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#28858;&#20102;&#25552;&#20379;&#26356;&#22909;&#30340;&#26381;&#21209;&#65292;&#26412;&#34892;&#30446;&#21069;&#27491;&#22312;&#36914;&#34892;&#30828;&#39636;&#21319;&#32026;&#20316;&#26989;&#12290; </p><p&#22914;&#20316;&#26989;&#38918;&#21033;&#26371;&#25552;&#26089;&#24674;&#24489;&#26381;&#21209;&#12290;&#36896;&#25104;&#24744;&#30340;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351; &#25964;&#21855;</p></body></html>"
    set ::ma_content_inpt "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#28858;&#20102;&#25552;&#20379;&#26356;&#22909;&#30340;&#26381;&#21209;&#65292;&#26412;&#34892;&#30446;&#21069;&#27491;&#22312;&#36914;&#34892;&#30828;&#39636;&#21319;&#32026;&#20316;&#26989;&#12290; </p><p> &#22914;&#20316;&#26989;&#38918;&#21033;&#26371;&#25552;&#26089;&#24674;&#24489;&#26381;&#21209;&#12290;&#36896;&#25104;&#24744;&#30340;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351; &#25964;&#21855;</p></body></html>"
    set ::ma_content_inpt2  "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#28858;&#20102;&#25552;&#20379;&#26356;&#22909;&#30340;&#26381;&#21209;&#65292;&#32178;&#38913;&#30446;&#21069;&#27491;&#22312;&#36914;&#34892;&#31995;&#32113;&#21319;&#32026;&#20316;&#26989;&#65292;&#25964;&#36992;&#24744;&#36681;&#33267;i&#32371;&#36027;&#12300;App&#12301;&#25110;&#25765;&#25171;&#35486;&#38899;&#36914;&#34892;&#32371;&#36027;&#65292;&#22914;&#36935;&#24537;&#32218;&#65292;&#35531;&#32784;&#24515;&#31245;&#24460;&#20877;&#37325;&#35430;&#65292;&#35613;&#35613;&#12290;</p><p>&nbsp;</p><p>&#36896;&#25104;&#24744;&#30340;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&#12299;&#40670;&#27492;&#19979;&#36617;APP&#65306;<a href=\"https://www.27608818.com/appweb/redirect.html\">https://www.27608818.com/appweb/redirect.html</a><p>&#12299;&#35486;&#38899;&#23560;&#32218;&#65306;(02)27608818</p></body></html>"
    set ::update_inpt "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\" /></head><script charset='UFT-8'>alert('i\u7e73\u8cbbAPP\u5168\u65b0\u6539\u7248\u518d\u51fa\u767c\uff0c\u8acb\u66f4\u65b0APP\u4ee5\u4eab\u6709\u6700\u65b0\u670d\u52d9\u9ad4\u9a57\uff0c\u8b1d\u8b1d');</script></html>"
}
when HTTP_REQUEST {
    set referer [string tolower [HTTP::header value "Referer"]]
    set reqURI [HTTP::uri];
    if { [HTTP::has_responded] } { return };
    if { [HTTP::uri] contains "/favicon.ico" }{
        HTTP::uri [string map {"/favicon.ico" "/web/favicon.ico"} [HTTP::uri]]
    }
	HTTP::header insert X-Forwarded-Proto "https"
   # ONECONNECT::reuse disable

# if { [HTTP::uri] starts_with "/web" && ![matchclass [IP::client_addr] equals INPT_WHITELIST] } {
#     HTTP::respond 503 content "<html><head><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"></head><body style=\"text-align:center;\"><h1>i&#32371;&#36027;&#31995;&#32113;&#32173;&#35703;&#20013;</h1><p>&#32173;&#35703;&#26399;&#38291;&#65306;2024/05/25 1:00 AM ~ 2024/05/25 03:00 AM</p><p>&#26412;&#26399;&#38291;&#12300;i&#32371;&#36027;&#32178;&#31449;&#12301;&#26283;&#20572;&#23416;&#36027;&#12289;&#29983;&#27963;&#32371;&#36027;&#65295;&#31237;&#32371;&#32013;&#21450;&#26597;&#35426;&#26381;&#21209;&#65292;&#35531;&#25913;&#33267;&#12300;i&#32371;&#36027;APP&#12301;&#36914;&#34892;&#32371;&#36027;&#21450;&#26597;&#35426;&#12290;&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;&#65281;</p> <p style=\"font-size: small;color: darkgray;\"><br>YOUR IP:[IP::client_addr]</p></body></html>" Connection Close
#     TCP::close
# }

        if { [HTTP::uri] starts_with "/ipaymentGW" }{

                if {[HTTP::uri] contains "/web/main/inputPayment.action"}{
                    HTTP::redirect "/web/tuition"
                }elseif {([HTTP::uri] contains "/web/main/inputPaymentByPost.action")}{
                    HTTP::respond 307 Location "https://www.27608818.com/ipaymentGW/iframe/confirmPaymentInfo.do"
                }elseif {([HTTP::uri] contains "/iframe/confirmPaymentInfo.do")}{
                    snat automap
                    pool POOL_INPT_IMAGE
                }elseif {([HTTP::uri] contains "/web/main/mainIndex.action")}{
                     HTTP::redirect "https://www.27608818.com/web/"
                }elseif  {([HTTP::uri] contains "/tes/payTes.do")}{
                    HTTP::uri [string map {"/ipaymentGW/tes/payTes.do" "/web/processTesPost"} [HTTP::uri]]
                    HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
                }
                elseif {([HTTP::uri] starts_with "/ipaymentGW/web/life/creditcardLife/mCreditcardLifePayment") || ([HTTP::uri] starts_with "/ipaymentGW/web/life/creditcardLife/creditcardLifePayment")}{
                    HTTP::redirect "/web/ccfee"
                }elseif {([HTTP::uri] starts_with "/ipaymentGW/i.html")}{
                    HTTP::redirect "/appweb/redirect.html"
                }elseif {([HTTP::uri] starts_with "/ipaymentGW/mobileWeb/index")}{
                    HTTP::redirect "/web"
                }elseif  {([HTTP::uri] starts_with "/ipaymentGW/qrcode.do")}{
                  if { ([HTTP::uri] contains "txn=")}{
                    snat automap
                    pool POOL_INPT_GW
                  } else {
                    #HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
                    #HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
                    if  { ([HTTP::method] eq "POST") and ([HTTP::uri] starts_with "/ipaymentGW/qrcode.do")}{      
                        HTTP::collect [HTTP::header Content-Length]          
                    } else {
                        HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
                        HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]" 
                    }
                  }

                }elseif {([HTTP::uri] starts_with "/ipaymentGW/api")}{
                    #HTTP::redirect "https://www.i-payment.com.tw/appweb/redirect.html"
                    snat automap
                    pool POOL_INPT_GW
                #HTTP::respond 200 content $::update_inpt
                }else {
                    HTTP::respond 200 content $::update_inpt
                }

        } elseif { ([HTTP::uri] starts_with "/appweb")}{
         # if { [HTTP::uri] starts_with "/appweb/redirect.html" }{
         #    HTTP::redirect "https://testpt.ctbcbank.com/uapp/redirect.html"
       #   }
          #HTTP::uri [string map {"/appweb" "/"} [HTTP::uri]]
          snat automap
          pool POOL_INPT_APP_WEB
        } elseif { ([HTTP::uri] starts_with "/PTAPP")}{
          if { ([HTTP::uri] starts_with "/PTAPP/api/directupdate")}{
            snat automap
            pool POOL_INPT_MFP_AP_DU
          } else {
            snat automap
            pool POOL_INPT_MFP_AP

            #if { [HTTP::header value "X-Production-Version"] equals "5.0.6"} {
            #    snat automap
            #    pool POOL_INPT_MFP_AP
            #} else {
            #    snat automap
            #    pool POOL_INPT_MFP_AP_SPLAP0007INPT
            #}
          }
        } elseif { ([HTTP::uri] starts_with "/IMP/directupdate/download/")}{
        	#HTTP::respond 403
        	snat automap
        	#pool POOL_INPT_NGINX
        	pool POOL_INPT_IMP
        } elseif { ([HTTP::uri] starts_with "/IMP")}{
        	#HTTP::respond 403
        	snat automap
        	pool POOL_INPT_IMP
        } elseif {[HTTP::uri] starts_with "/tuipaymtUPOP/pages/unionPay/returnMessage.faces" }{
         HTTP::uri [string map {"/tuipaymtUPOP/pages/unionPay/returnMessage.faces" "/web/npgCallBackToRedirect"} [HTTP::uri]]
         HTTP::respond 307 Location "https://www.27608818.com[HTTP::uri]"
        } elseif {[HTTP::uri] starts_with "/tuipaymtUPOP/callBackService" }{
           HTTP::uri [string map {"/tuipaymtUPOP/callBackService" "/web/npgCallBackToProcess"} [HTTP::uri]]
           snat automap
           pool POOL_INPT_WEB_8083
        } elseif {[HTTP::uri] starts_with "/tuipaymtUPOP/pages/unionPay/query.faces" }{
           HTTP::uri [string map {"/tuipaymtUPOP/pages/unionPay/query.faces" "/web/inputTuitionUpopPayment"} [HTTP::uri]]
           snat automap
           pool POOL_INPT_WEB_8083
        } elseif {([HTTP::uri] starts_with "/tuipaymt/index.jsp") || ([HTTP::uri] contains "/tuipaymt/student")}
        {
            HTTP::redirect "https://www.27608818.com/web/"
            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } elseif {[HTTP::uri] starts_with "/tuipaymt2" }
        {

                snat automap
                pool POOL_INPT_TUIPAYMT2_EXT
            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } elseif {[HTTP::uri] starts_with "/tuipaymt" }
        {
            if {[HTTP::uri] starts_with "/tuipaymt/taichungPark/browser/parkgFeeQuery.faces" }{
               HTTP::uri [string map {"/tuipaymt/taichungPark/browser/parkgFeeQuery.faces" "/web/parkingbill?transType=02"} [HTTP::uri]]
               snat automap
               pool POOL_INPT_WEB_8083
            } elseif {[HTTP::uri] starts_with "/tuipaymt/taichungPark/webview/parkgFeeQuery.faces" }{
               HTTP::uri [string map {"/tuipaymt/taichungPark/webview/parkgFeeQuery.faces" "/web/parkingbill?transType=02"} [HTTP::uri]]
               snat automap
               pool POOL_INPT_WEB_8083
            } elseif {[HTTP::uri] starts_with "/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces" }{
              HTTP::uri [string map {"/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces" "/web/taichungFormPostRedirect"} [HTTP::uri]]
              snat automap
              pool POOL_INPT_WEB_8083
                  # snat automap
                  # pool POOL_INPT_GW
          #  } elseif { ([HTTP::uri] starts_with "/tuipaymt/taichungPark") ||  ([HTTP::uri] starts_with "/tuipaymt/css") || ([HTTP::uri] starts_with "/tuipaymt/tui-asset") }{
               #HTTP::uri [string map {"/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces" "/web/taichungFormPostRedirect"} [HTTP::uri]]
           #    snat automap
           #    pool POOL_INPT_GW
               #pool POOL_INPT_WEB_8083_INTRA
            } elseif {[HTTP::uri] starts_with "/tuipaymt/webApi" }{
                HTTP::uri [string map {"/tuipaymt/webApi/webApiFacade.faces" "/tuipaymt2/webApi/webApiFacade.faces"} [HTTP::uri]]
                snat automap
                pool POOL_INPT_TUIPAYMT2_EXT
            } else {
                HTTP::redirect "https://www.27608818.com/tuipaymt2/"
            }



            #log local0. "INPT TUIPAYMT [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } elseif { [HTTP::uri] starts_with "/api"  }
    {
        snat automap
        pool POOL_INPT_OPENAPI_8080
        #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    } elseif { [HTTP::uri] starts_with "/web" } {
        #if {[HTTP::uri] starts_with "/web/parkingbill?transType=02" }{
           #HTTP::uri [string map {"/web/parkingbill?transType=02" "/tuipaymt/taichungPark/browser/parkgFeeQuery.faces"} [HTTP::uri]]
        #   snat automap
         #  pool POOL_INPT_WEB_8083
       # } elseif {[HTTP::uri] starts_with "/web/taichungFormPostRedirect" }{
           #HTTP::uri [string map {"/web/taichungFormPostRedirect" "/tuipaymt/taichungPark/webview/parkgFeeQueryBarCode.faces"} [HTTP::uri]]
       #    snat automap
        #   pool POOL_INPT_WEB_8083
       # } else {
             snat automap
             pool POOL_INPT_WEB_8083
     #   }

      #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    } elseif { [HTTP::uri] starts_with "/source" } {

      snat automap
      pool POOL_INPT_IMAGE
      #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    } elseif { [HTTP::uri] starts_with "/.well-known" } {

      snat automap
      pool POOL_INPT_APP_WEB
    } else {
                HTTP::redirect "https://www.27608818.com/web/"
            #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
    }
}


# when HTTP_REQUEST_DATA {
#     HTTP::uri [string map {"/ipaymentGW/qrcode.do" "/web/tuition"} [HTTP::uri]]
#     HTTP::respond 302 Location "https://www.27608818.com[HTTP::uri]?vData=[findstr [HTTP::payload] "vData=" 6 &]"
# }


when HTTP_RESPONSE {
    set module [HTTP::header value "module-name"]


    HTTP::header remove Server
    foreach header_name [HTTP::header names] {
       #X-Frame-Options
       #&#20027;&#27231;&#23553;&#21253;&#27161;&#38957;&#36039;&#35338;&#27945;&#28431;&#20027;&#27231;&#12289;&#22871;&#20214;&#29256;&#26412; X-Powered-By
       #X-&#38283;&#38957;&#30340;&#37117;&#26371;&#34987;&#31227;&#25481;
       if {[string match -nocase X-* $header_name]}{
           if { ($header_name starts_with "x-auth-token")}{
           } else {
                HTTP::header remove $header_name
           }
       }
    }

    #iRule_dispatch_setCookie_HTTP_HTTPS_only &#24050;&#35373;
    #HTTP::header insert "X-Frame-Options" "SAMEORIGIN"
    HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubDomains"
    HTTP::header insert "X-Content-Type-Options" "nosniff"
    HTTP::header insert "X-Forwarded-Proto" "https"
    HTTP::header insert "X-XSS-Protection" "1; mode=block"
    HTTP::header remove "permissions-policy"
    HTTP::header insert "permissions-policy" "camera=(), geolocation=(), microphone=()"
    HTTP::header insert "Content-Security-Policy"  "default-src 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.google-analytics.com https://ssl.google-analytics.com https://www.googleadservices.com https://googleads.g.doubleclick.net https://*.googletagmanager.com https://tagmanager.google.com; style-src 'self' 'unsafe-inline' https://tagmanager.google.com https://fonts.googleapis.com; img-src 'self' data: https://ipayment.ctbcbank.com https://www.google.com https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw https://ssl.gstatic.com https://www.gstatic.com; connect-src 'self' https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw; font-src 'self' data: https://fonts.gstatic.com; frame-src 'self' https://bid.g.doubleclick.net; media-src 'self' data:;"

    if {($reqURI starts_with "/web/freego")} {
        HTTP::header remove "permissions-policy"
        HTTP::header insert "permissions-policy" "camera=(), geolocation=(), microphone=(self)"
        #HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; media-src 'self' data:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
    }
    #elseif {($reqURI starts_with "/web/")}{
		#HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' 'unsafe-inline' https://tagmanager.google.com https://*.googletagmanager.com https://www.google-analytics.com https://ssl.google-analytics.com; img-src 'self' data: www.googletagmanager.com https://*.ctbcbank.com https://*.google-analytics.com https://*.googletagmanager.com https://googleads.g.doubleclick.net https://www.google.com https://www.google.com.tw; connect-src 'self' https://*.google-analytics.com https://analytics.google.com https://*.analytics.google.com https://*.googletagmanager.com https://*.g.doubleclick.net;"
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} elseif {($reqURI starts_with "/tuipaymt2/")}{
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} elseif {($reqURI starts_with "/ipaymentGW/")}{
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} elseif {($reqURI starts_with "/source/img/")}{
#		HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: https://ipayment.ctbcbank.com;"
#	} else {
        #Origin
   #     HTTP::header insert "Content-Security-Policy" "default-src * data: blob: ws: wss: gap://ready file://* 'unsafe-inline' 'unsafe-eval';script-src * 'unsafe-inline' 'unsafe-eval' 'unsafe-inline';connect-src * 'unsafe-inline';img-src * data: blob: 'unsafe-inline';frame-src * data: blob:;style-src * 'unsafe-inline';frame-ancestors 'self'"   
   # }   
    HTTP::header remove "Cache-Control"
    HTTP::header insert "Cache-Control" "no-store, max-age=0"
    HTTP::header insert "Referrer-Policy" "strict-origin-when-cross-origin"
    if { ([HTTP::header value Content-Type] contains "image/jpeg") or ([HTTP::header value Content-Type] contains "image/png") or ([HTTP::header value Content-Type] contains "text/javascript") or ([HTTP::header value Content-Type] contains "text/css") } {
       #if { [HTTP::header Content-Length] > 300 } { 
             #image ad use cache control to reduce network access
         HTTP::header remove "Cache-Control"
         HTTP::header insert "Cache-Control" "private, max-age=600"
       #}
    }

    if {  ($reqURI starts_with "/PTAPP")  || ($reqURI starts_with "/appweb") || ($reqURI starts_with "/IMP")} {
        #MFP don't redirect fail status to RWD

    } else {
           if { ([HTTP::status] == 400 ) || ([HTTP::status] == 401 ) || ([HTTP::status] == 404 )|| ([HTTP::status] == 405 ) || ([HTTP::status] == 407 ) || ([HTTP::status] == 417 ) || [HTTP::status] == 500 || ([HTTP::status] == 503 )} {

                 if {($reqURI starts_with "/web/freego")} {
                    HTTP::redirect "/web/freego"
                }else {
                    HTTP::redirect "/web/"
                }

            }
   }
}
when HTTP_RESPONSE_RELEASE {
  if { !([HTTP::header exists "Strict-Transport-Security"])} {
    HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubDomains"
  }
}

when HTTP_RESPONSE_RELEASE priority 900 {
  if { [HTTP::header count {Set-Cookie} ] > 0 } {
        set COOKIE_VAL [HTTP::header values {Set-Cookie}] 
        HTTP::header remove {Set-Cookie} 
        foreach COOKIE_NAME $COOKIE_VAL {
            if { !([string match -nocase {*SameSite=*} ${COOKIE_NAME}] || [string match -nocase {*Secure*} ${COOKIE_NAME}] || [string match -nocase {*HTTPOnly*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax; Secure; HTTPOnly;" 
            } elseif { !([string match -nocase {*SameSite=*} ${COOKIE_NAME}] || [string match -nocase {*Secure*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax; Secure;"
            } elseif { !([string match -nocase {*SameSite=*} ${COOKIE_NAME}] || [string match -nocase {*HTTPOnly*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax; HTTPOnly;" 
            } elseif { !([string match -nocase {*Secure*} ${COOKIE_NAME}] || [string match -nocase {*HTTPOnly*} ${COOKIE_NAME}])} {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; Secure; HTTPOnly;"
            } else {
                HTTP::header insert {Set-Cookie} "${COOKIE_NAME}; SameSite=Lax;"
            }
        }
    } else {
        HTTP::header replace Set-Cookie "pt=secure; SameSite=Lax; Path=/; Secure; HTTPOnly"
        HTTP::cookie secure "pt" enable
        HTTP::cookie httponly "pt" enable
    }
}

when LB_FAILED {
    if {([HTTP::uri] starts_with "/PTAPP") || ([HTTP::uri] starts_with "/IMP")}{
        #MFP don't redirect fail status to RWD
    } else {
        HTTP::respond 200 content $::ma_content_inpt
    } 
}
}
ltm rule /INPT/iRule_INPT_ESB_F5 {
when HTTP_REQUEST {
    snat automap
    pool POOL_INPT_OPENAPI_8080
    log local0. "INPT IntraESB [IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
}
}
ltm rule /INPT/iRule_INPT_REMOVE_HEADER {
when HTTP_RESPONSE {
	if { [HTTP::has_responded] } { return };
    HTTP::header remove Server

    foreach header_name [HTTP::header names] {

       #X-Frame-Options
       #&#20027;&#27231;&#23553;&#21253;&#27161;&#38957;&#36039;&#35338;&#27945;&#28431;&#20027;&#27231;&#12289;&#22871;&#20214;&#29256;&#26412; X-Powered-By
       #X-&#38283;&#38957;&#30340;&#37117;&#26371;&#34987;&#31227;&#25481;
       if {[string match -nocase X-* $header_name]}{

           HTTP::header remove $header_name
       }
    }

    HTTP::header insert "X-Frame-Options" "SAMEORIGIN"


    #&#32178;&#31449;&#30340;&#23553;&#21253;&#27161;&#38957;&#23660;&#24615;&#32570;&#23569;X-Content-Type-Options
    if {![HTTP::header exists "X-Content-Type-Options"] } { 
       HTTP::header insert "X-Content-Type-Options" "nosniff" 
    }
    if {![HTTP::header exists "X-XSS-Protection"] } { 
        HTTP::header insert "X-XSS-Protection" "1; mode=block" 
    }
    HTTP::header insert "Content-Security-Policy" "default-src * data: blob: ws: wss: gap://ready file://* 'unsafe-inline' 'unsafe-eval' ;script-src * 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com 'unsafe-inline'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline';frame-src * data: blob:;style-src * 'unsafe-inline';frame-ancestors 'self'"
    HTTP::header insert "Referrer-Policy" "no-referrer-when-downgrade"
    HTTP::header insert "permissions-policy" "microphone=(),midi=()"
}
}
ltm virtual /INPT/VS_INPT_EXT_175.184.240.192_443 {
    destination /Common/175.184.240.192:443
    ip-protocol tcp
    last-modified-time 2024-09-13:14:38:11
    mask 255.255.255.255
    persist {
        /INPT/cookie_insert_inpt_secure {
            default yes
        }
    }
    policies {
        /INPT/asm_auto_l7_policy__VS_INPT_EXT_175.184.240.192_443 { }
    }
    pool /INPT/POOL_INPT_WEB_8083
    profiles {
        /Common/HTTP_X_forward { }
        /Common/http2 { }
        /Common/httpcompression { }
        /Common/tcp { }
        /Common/websecurity { }
        /INPT/ASM_SP_INPT { }
        /INPT/inpt_ssl_profile {
            context clientside
        }
    }
    rules {
        /Common/iRule_Block_HTTP_TRACE
        /INPT/iRule_Dispatch_INPT_NAP_NewPlatform
        /Common/iRule_dispatch_setCookie_HTTP_HTTPS_only
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual /INPT/VS_INPT_Intra_192.168.212.20_443 {
    destination /Common/192.168.212.20:443
    ip-protocol tcp
    last-modified-time 2024-02-16:18:30:30
    mask 255.255.255.255
    persist {
        /INPT/cookie_insert_inpt_secure {
            default yes
        }
    }
    policies {
        /INPT/asm_auto_l7_policy__VS_INPT_Intra_192.168.212.20_443 { }
    }
    pool /INPT/POOL_INPT_WEB_8083
    profiles {
        /Common/HTTP_X_forward { }
        /Common/http2 { }
        /Common/httpcompression { }
        /Common/tcp { }
        /Common/websecurity { }
        /INPT/ASM_SP_INPT { }
        /INPT/inpt_ssl_profile {
            context clientside
        }
    }
    rules {
        /Common/iRule_Block_HTTP_TRACE
        /INPT/iRule_Dispatch_INPT_Allowed_NewPlatform
        /Common/iRule_dispatch_setCookie_HTTP_HTTPS_only
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual /INPT/VS_INPT_Intra_192.168.212.20_8080 {
    destination /Common/192.168.212.20:8080
    ip-protocol tcp
    mask 255.255.255.255
    pool /INPT/POOL_INPT_OPENAPI_8080
    profiles {
        /Common/HTTP-Comp_CTBC { }
        /Common/HTTP_X_forward { }
        /Common/tcp { }
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        type automap
    }
    translate-address enabled
    translate-port enabled
}
ltm persistence cookie /INPT/cookie_insert_inpt_secure {
    app-service none
    defaults-from /Common/cookie_insert_inpt
    encrypt-cookie-poolname enabled
}
ltm profile client-ssl /INPT/inpt_ssl_profile {
    alert-timeout 60
    allow-dynamic-record-sizing disabled
    allow-non-ssl disabled
    app-service none
    cache-size 262144
    cache-timeout 3600
    cert /Common/INPT_SSL_2025
    cert-key-chain {
        INPT_SSL_2025_INPT_SSL_2025_UCA_0 {
            cert /Common/INPT_SSL_2025
            chain /Common/INPT_SSL_2025_UCA
            key /Common/INPT_SSL_2025
        }
    }
    chain /Common/INPT_SSL_2025_UCA
    cipher-group none
    ciphers ECDHE:!3DES:!SHA1
    defaults-from /Common/inpt_ssl_profile
    generic-alert enabled
    handshake-timeout 60
    inherit-ca-certkeychain true
    inherit-certkeychain false
    key /Common/INPT_SSL_2025
    max-active-handshakes indefinite
    max-aggregate-renegotiation-per-minute indefinite
    max-renegotiations-per-minute 5
    maximum-record-size 16384
    mod-ssl-methods disabled
    mode enabled
    notify-cert-status-to-virtual-server disabled
    ocsp-stapling disabled
    options { dont-insert-empty-fragments no-tlsv1.3 no-tlsv1.1 single-dh-use no-sslv3 no-tlsv1 }
    passphrase none
    peer-no-renegotiate-timeout 10
    proxy-ssl disabled
    proxy-ssl-passthrough disabled
    renegotiate-max-record-delay 10
    renegotiate-period indefinite
    renegotiate-size 1000mb
    renegotiation disabled
    secure-renegotiation require
    server-name none
    session-mirroring disabled
    session-ticket disabled
    session-ticket-timeout 0
    sni-default false
    sni-require false
    ssl-sign-hash any
    strict-resume disabled
    unclean-shutdown enabled
}
security bot-defense asm-profile /INPT/ASM_SP_INPT {
    app-service none
}
