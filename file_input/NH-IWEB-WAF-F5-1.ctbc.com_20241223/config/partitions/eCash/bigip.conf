#TMSH-VERSION: 17.1.1.3

analytics application-security scheduled-report /eCash/WAF_Daily_Report {
    email-addresses { harris.chang@chinatrust.com.tw alvin.wu@chinatrust.com.tw }
    first-time 2013-10-21:12:00:00
    frequency every-24-hours
    last-failure-time 2024-12-23:14:01:03
    last-run-error-message "No SMTP server configuration defined for /eCash/WAF_Daily_Report,scheduled report skipped.
"
    last-run-status failure
    module-name asm
    multi-leveled-report {
        chart-path { asm_repev_attack_type asm_repev_security_policy }
        measures { events_count }
        time-diff last-day
        view-by asm_repev_violation
    }
    next-time 2013-10-21:12:00:00
}
apm client-packaging /eCash/client-packaging { }
apm resource sandbox /eCash/citrix-client-package {
    base-uri /eCash/public/citrix
    description "Sandbox for Citrix client package files"
}
apm resource sandbox /eCash/hosted-content {
    base-uri /eCash/public/share
    description "Sandbox for static contents"
}
asm policy /eCash/SP_SMEAPP {
    active
    encoding utf-8
}
asm policy /eCash/SP_eCash {
    active
    encoding utf-8
}
ltm node /eCash/10.24.70.4 {
    address 10.24.70.4
}
ltm node /eCash/10.24.70.5 {
    address 10.24.70.5
}
ltm node /eCash/10.24.70.6 {
    address 10.24.70.6
}
ltm node /eCash/10.24.70.7 {
    address 10.24.70.7
}
ltm node /eCash/10.24.70.10 {
    address 10.24.70.10
}
ltm node /eCash/10.24.70.11 {
    address 10.24.70.11
}
ltm node /eCash/10.24.70.12 {
    address 10.24.70.12
}
ltm node /eCash/10.24.70.13 {
    address 10.24.70.13
}
ltm node /eCash/10.24.70.85 {
    address 10.24.70.85
}
ltm node /eCash/10.24.70.86 {
    address 10.24.70.86
}
ltm node /eCash/10.24.70.87 {
    address 10.24.70.87
}
ltm node /eCash/10.24.70.88 {
    address 10.24.70.88
}
ltm node /eCash/10.243.137.65 {
    address 10.243.137.65
}
ltm node /eCash/10.243.137.66 {
    address 10.243.137.66
}
ltm node /eCash/10.243.137.67 {
    address 10.243.137.67
}
ltm node /eCash/10.248.73.138 {
    address 10.248.73.138
}
ltm node /eCash/10.248.73.139 {
    address 10.248.73.139
}
ltm node /eCash/ECASH-3SCALE {
    description ECASH-3SCALE
    fqdn {
        address-family all
        name ecash-api-3scale-apicast-production.apps.scp01.ctbcbank.com
    }
}
ltm policy /eCash/asm_auto_l7_policy__VS_ECASH_EXT_175.184.243.77_80 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /eCash/SP_eCash
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /eCash/asm_auto_l7_policy__VS_ECASH_EXT_175.184.243.77_443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /eCash/SP_eCash
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /eCash/asm_auto_l7_policy__VS_ECASH_INTRA_192.168.212.24_443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /eCash/SP_eCash
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /eCash/asm_auto_l7_policy__VS_ECASH_INTRA_192.168.212.24_8443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /eCash/SP_eCash
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /eCash/asm_auto_l7_policy__VS_ECASH_SMEAPP_175.184.240.187_443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /eCash/SP_SMEAPP
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm pool /eCash/POOL_ECASH_AP {
    load-balancing-mode ratio-member
    members {
        /eCash/10.24.70.10:7003 {
            address 10.24.70.10
            ratio 7
        }
        /eCash/10.24.70.11:7003 {
            address 10.24.70.11
            ratio 7
        }
        /eCash/10.24.70.12:7003 {
            address 10.24.70.12
            ratio 3
            session user-disabled
            state user-down
        }
        /eCash/10.24.70.13:7003 {
            address 10.24.70.13
            ratio 3
            session user-disabled
            state user-down
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_ECASH_AP_INTRA {
    members {
        /eCash/10.24.70.10:7003 {
            address 10.24.70.10
        }
        /eCash/10.24.70.11:7003 {
            address 10.24.70.11
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_ECASH_BA_INTRA {
    members {
        /eCash/10.24.70.12:7004 {
            address 10.24.70.12
        }
        /eCash/10.24.70.13:7004 {
            address 10.24.70.13
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_ECASH_BD {
    description "eCash back desk"
    load-balancing-mode ratio-member
    members {
        /eCash/10.24.70.10:7013 {
            address 10.24.70.10
            ratio 3
        }
        /eCash/10.24.70.11:7013 {
            address 10.24.70.11
            ratio 3
        }
        /eCash/10.24.70.12:7013 {
            address 10.24.70.12
            ratio 3
            session user-disabled
            state user-down
        }
        /eCash/10.24.70.13:7013 {
            address 10.24.70.13
            ratio 3
            session user-disabled
            state user-down
        }
        /eCash/10.24.70.4:7013 {
            address 10.24.70.4
            ratio 3
            session user-disabled
        }
        /eCash/10.24.70.5:7013 {
            address 10.24.70.5
            ratio 3
            session user-disabled
        }
        /eCash/10.24.70.6:7013 {
            address 10.24.70.6
            ratio 3
            session user-disabled
            state user-down
        }
        /eCash/10.24.70.7:7013 {
            address 10.24.70.7
            ratio 3
            session user-disabled
            state user-down
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_ECASH_SMEAPP_81 {
    description POOL_ECASH_SMEAPP_81
    members {
        /eCash/10.243.137.65:81 {
            address 10.243.137.65
        }
        /eCash/10.243.137.66:81 {
            address 10.243.137.66
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_SB_IMP_PRD {
    members {
        /eCash/10.248.73.138:9080 {
            address 10.248.73.138
        }
        /eCash/10.248.73.139:9080 {
            address 10.248.73.139
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_SB_IMP_PRD_NGINX {
    members {
        /eCash/10.248.73.138:1080 {
            address 10.248.73.138
        }
        /eCash/10.248.73.139:1080 {
            address 10.248.73.139
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_SB_MFP {
    description POOL_SB_MFP
    members {
        /eCash/10.24.70.87:9080 {
            address 10.24.70.87
        }
        /eCash/10.24.70.87:9081 {
            address 10.24.70.87
            session user-disabled
        }
        /eCash/10.24.70.88:9080 {
            address 10.24.70.88
        }
        /eCash/10.24.70.88:9081 {
            address 10.24.70.88
            session user-disabled
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_SB_OCP_API {
    description POOL_SB_OCP_API
    members {
        /eCash/ECASH-3SCALE:80 {
            description ECASH-3SCALE
            monitor /Common/tcp
            fqdn {
                name ecash-api-3scale-apicast-production.apps.scp01.ctbcbank.com
            }
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_SB_TAGGING {
    description POOL_SB_TAGGING
    members {
        /eCash/10.24.70.85:80 {
            address 10.24.70.85
        }
        /eCash/10.24.70.86:80 {
            address 10.24.70.86
        }
    }
    monitor /Common/tcp
}
ltm pool /eCash/POOL_eCash_AP_learn {
    description ecash-learn
    members {
        /eCash/10.24.70.7:7099 {
            address 10.24.70.7
        }
    }
    monitor /Common/tcp
}
ltm rule /eCash/BLock_eCash_Strust2 {
when HTTP_REQUEST {
	set post "0"
	set get "0"
	if {[HTTP::query] matches_regex ".action|redirect|redirectAction.*"}
	{
		HTTP::redirect "https://ecash.ctbcbank.com/PCMS/index"
		#log local0. "eCash_Occur_[IP::client_addr]_[HTTP::uri]: Invalid Signature violation rule ID 1000002: s2-016, blocking HTTP request."
	}
}
}
ltm rule /eCash/iRule_ECASH_ALLOW {
when HTTP_REQUEST {
  if { ([class match [IP::client_addr] equals ECASH_ALLOW]) }
  {
    pool POOL_ECASH_AP
    log local0. "[IP::remote_addr] to eCash PCMSTest Server ..."
  } else {  
    HTTP::respond 200 content "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#32218;&#19978;&#25910;&#20184;&#32178;e-Cash &#24179;&#21488;&#30446;&#21069;&#27491;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#20013;&#65292;&#38928;&#35336;12/14 &#19978;&#21320;7:00 &#24674;&#24489;&#27491;&#24120;&#29151;&#36939;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#32218;&#19978;&#25910;&#20184;&#32178; e-Cash &#25964;&#21855;</p></body></html>"
  }
}
}
ltm rule /eCash/iRule_SME_HEADER {
when HTTP_RESPONSE_RELEASE {


    if {!([HTTP::header exists "Content-Security-Policy"])} {

       HTTP::header insert "Content-Security-Policy" "default-src 'self' https://smeapp.ctbcbank.com:* ; script-src 'self' https://smeapp.ctbcbank.com:*; connect-src 'self' ; img-src 'self' data: ; style-src 'self' ; object-src 'none' ; frame-src 'self' https://smeapp.ctbcbank.com:* ; font-src 'self'; frame-ancestors 'self' ; "  
    }

}
}
ltm rule /eCash/iRule_SME_MFE_CORS {
when HTTP_REQUEST {
    unset -nocomplain ECASH_MFE_CORS_ALLOW
    if { [class match [HTTP::header Origin] ends_with ECASH_MFE_CORS_ALLOW] } {
        if { ( [HTTP::method] equals "OPTIONS" ) and ( [HTTP::header exists "Access-Control-Request-Method"] ) } {
            # CORS preflight request - return response immediately
            HTTP::respond 200 "Access-Control-Allow-Origin" [HTTP::header "Origin"] \
                              "Access-Control-Allow-Methods" [HTTP::header "Access-Control-Request-Method"] \
                              "Access-Control-Allow-Headers" [HTTP::header "Access-Control-Request-Headers"] \
                              "Access-Control-Max-Age" "86400" \
                              "Vary" "Origin"
        } else {
            # CORS GET/POST requests - set ECASH_MFE_CORS_ALLOW variable
            set ECASH_MFE_CORS_ALLOW [HTTP::header "Origin"]
        }
    }
}

when HTTP_RESPONSE {
    # CORS GET/POST response - check cors_origin variable set in request
    if { [info exists ECASH_MFE_CORS_ALLOW] } {
        HTTP::header insert "Access-Control-Allow-Origin" $ECASH_MFE_CORS_ALLOW
        HTTP::header insert "Access-Control-Allow-Credentials" "true"
        HTTP::header insert "Vary" "Origin"
    }
}
}
ltm rule /eCash/iRule_SME_ROUTER {
#when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count TT
#  set ::html_content_Ext "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#20225;&#26989;&#25910;&#20184;e-Cash &#24179;&#21488;&#31995;&#32113;&#32173;&#35703;&#20013;&#65292;&#35531;&#31245;&#24460;&#20877;&#35430;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
#} 

when HTTP_REQUEST {
    HTTP::header remove Range
    HTTP::header remove Request-Range

    #if {[HTTP::uri] starts_with "/api/adapters/SME_Adapter/resource" } {
     #   node 10.154.0.111 80
    #}else
    if {[HTTP::uri] starts_with "/content" } { 
        node 10.23.96.99 80
    }elseif {[HTTP::uri] starts_with "/SB/" } { 
        HTTP::header insert "app_id" "60783fe8"
        HTTP::header insert "app_key" "343950d54e90474e231b2e3768f19169"
        pool POOL_SB_MFP
    }elseif { ([HTTP::uri] starts_with "/webads") or ([HTTP::uri] starts_with "/jscollection")}{
        # &#27298;&#26597;&#26159;&#21542;&#24050;&#32147;&#26377; Cookies
        if 
        { [HTTP::cookie exists "v1st"] } {
            # &#22914;&#26524;&#24050;&#23384;&#22312;&#65292;&#21487;&#20197;&#22312;&#36889;&#35041;&#36914;&#34892;&#30456;&#25033;&#34389;&#29702;
        } else {
            # &#29983;&#25104;&#19968;&#20491;&#38263;&#24230;&#28858; 16 &#30340;&#38568;&#27231;&#23383;&#20018;&#65292;&#21253;&#21547; 0-9 &#21644; A-F
            set characters "123456789ABCDEF"
            set random_value ""
            for {set i 0} {$i < 16} {incr i} {
                append random_value [string index $characters [expr {int(rand() * [string length $characters])}]]
            }
            # &#26032;&#22686;&#21517;&#28858; "v1st" &#30340; Cookies&#65292;&#20540;&#28858;&#38568;&#27231;&#23383;&#20018;
            HTTP::respond 200 "Set-Cookie" "v1st=$random_value; Path=/; Secure; SameSite=None; HttpOnly; expires=Fri, 31 Dec 2123 23:59:59 GMT"
        }

        #TAGGING SERVER
        pool POOL_SB_TAGGING
    }elseif {[HTTP::uri] starts_with "/PCMS/"} {
        #for &#26410;&#20358;&#21295;&#29575;&#20351;&#29992;
        pool POOL_ECASH_AP_INTRA
    }elseif {[HTTP::uri] starts_with "/MFE/" } {
          if {[HTTP::host] equals "smeapp.ctbcbank.com"} {
                pool POOL_SB_OCP_API
          }
    }elseif { ([HTTP::uri] starts_with "/IMP/oauth/token") or ([HTTP::uri] starts_with "/IMP/main/init") or ([HTTP::uri] starts_with "/IMP/directupdate/checkVersion") or ([HTTP::uri] starts_with "/IMP/devicelog/uploadContent") or ([HTTP::uri] starts_with "/IMP/api/adapters")}{


        #IMP SERVER
        pool POOL_SB_IMP_PRD
    }elseif {[HTTP::uri] starts_with "/IMP/directupdate/download/" } {

        #IMP SERVER NGINX

        pool POOL_SB_IMP_PRD_NGINX
    } else { 
        if {[HTTP::uri] starts_with "/"} {
            #&#38750;&#20197;&#19978;&#26781;&#20214;&#21063;&#23566;&#20837;&#25512;&#24291;&#38913;&#38754;
            #HTTP::redirect "https://www.ctbcbank.com/content/dam/minisite/long/sb/NB2022040608/index.html"
            HTTP::redirect "https://www.ctbcbank.com/content/dam/ctbc-sbib/zh_tw/general/PRO_URL.html"
        } 

    }
}

when HTTP_RESPONSE_RELEASE {
    HTTP::header insert Permissions-Policy "microphone=(),midi=()"
}
}
ltm rule /eCash/iRule_eCash_BD {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Intra "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#20225;&#26989;&#25910;&#20184;e-Cash &#24179;&#21488;&#21450; &#20195;&#25910;&#20184;&#24460;&#21488;&#31649;&#29702;&#31995;&#32113; &#30446;&#21069;&#27491;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#20013;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
} 

when HTTP_REQUEST {
   if { [HTTP::has_responded] } { return }; 
   if { ([HTTP::uri] starts_with "/PCMS/LoginIntra") || ([HTTP::uri] starts_with "/PCMS/LoginedIntraHome")}
  {
    pool POOL_ECASH_BD
    #log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } elseif {[HTTP::uri] starts_with "/PCMS/Login"}
  {
    HTTP::redirect "https://ecash.ctbcbank.com/"
    #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } elseif { [HTTP::uri] starts_with "/PCMS"}
  {
    pool POOL_ECASH_BD
    #log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } else {
    HTTP::redirect "https://ecash.ctbcbank.com:8443/PCMS/LoginIntra"
    #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  }
}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Intra
}

when HTTP_RESPONSE { HTTP::header insert "X-UA-Compatible" "IE=edge,chome=1"}
}
ltm rule /eCash/iRule_eCash_CTBC_Intra {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Intra "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#32218;&#19978;&#25910;&#20184;&#32178;e-Cash &#24179;&#21488;&#21450; &#20195;&#25910;&#20184;&#24460;&#21488;&#31649;&#29702;&#31995;&#32113; &#30446;&#21069;&#27491;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#20013;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#32218;&#19978;&#25910;&#20184;&#32178; e-Cash &#25964;&#21855;</p></body></html>"
} 

when HTTP_REQUEST {
   if { ([HTTP::uri] starts_with "/PCMS/LoginIntra") || ([HTTP::uri] starts_with "/PCMS/LoginedIntraHome")}
  {
    pool POOL_ECASH_AP
    log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } elseif {[HTTP::uri] starts_with "/PCMS/Login"}
  {
    HTTP::redirect "https://ecash.ctbcbank.com/"
    log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } elseif { [HTTP::uri] starts_with "/PCMS"}
  {
    pool POOL_ECASH_AP
    log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } else {
    HTTP::redirect "https://ecash.ctbcbank.com:8443/PCMS/LoginIntra"
    log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  }
}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Intra
}
}
ltm rule /eCash/iRule_eCash_Ext {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Ext "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#32218;&#19978;&#25910;&#20184;&#32178;e-Cash &#24179;&#21488;&#31995;&#32113;&#32173;&#35703;&#20013;&#65292;&#35531;&#31245;&#24460;&#20877;&#35430;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#32218;&#19978;&#25910;&#20184;&#32178; e-Cash &#25964;&#21855;</p></body></html>"
} 

when HTTP_REQUEST {
  if { [HTTP::uri] starts_with "/PCMS/LoginIntra" }
  {
    HTTP::redirect "https://ecash.chinatrust.com.tw/PCMS/Login"
    log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
   }
   else {
    pool POOL_ECASH_AP
    #log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  }
}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Ext
}
}
ltm rule /eCash/iRule_eCash_Intra {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Intra "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#20225;&#26989;&#25910;&#20184;e-Cash &#24179;&#21488;&#21450; &#20195;&#25910;&#20184;&#24460;&#21488;&#31649;&#29702;&#31995;&#32113; &#30446;&#21069;&#27491;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#20013;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
} 

when HTTP_REQUEST {
  if { [HTTP::uri] starts_with "/PCMS/Login"}
  {
    pool POOL_ECASH_AP
    #log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  } elseif {[HTTP::uri] starts_with "/PCMSIntra"}
  {
    #log local0. "PCMSIntra Error...."
    HTTP::redirect "https://ecash.chinatrust.com.tw/PCMS/LoginIntra"
    #log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
  }
}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Intra
}
}
ltm rule /eCash/iRule_eCash_header_prod {
when HTTP_RESPONSE_RELEASE {

  if { [HTTP::has_responded] } { return };
  set myValues [HTTP::cookie names]

  foreach mycookies $myValues {

    #2021&#28402;&#36879;&#28204;&#35430;,&#33509;&#26377;&#21839;&#38988;&#21487;&#31227;&#38500;  

    HTTP::cookie attribute $mycookies insert { SameSite=None}

  }

  #HTTP::header insert "Referrer-Policy"

   if {!([HTTP::header exists "Referrer-Policy"])} {

      HTTP::header insert "Referrer-Policy" "strict-origin-when-cross-origin"

    }


    if {!([HTTP::header exists "Permissions-Policy"])} {

        HTTP::header insert Permissions-Policy "camera=(), microphone=(), geolocation=()"

   }


#   if {([HTTP::header exists "Content-Security-Policy"])} {

#         HTTP::header remove Content-Security-Policy

#         HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:*;connect-src 'self' ;img-src 'self' data: ;style-src 'self' 'unsafe-inline'  ;object-src 'none' ;frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;font-src 'self';frame-ancestors 'self'"

#   }

#     if {!([HTTP::header exists "Content-Security-Policy"])} {

#         HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:*;connect-src 'self' ;img-src 'self' data: ;style-src 'self' 'unsafe-inline'  ;object-src 'none' ;frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;font-src 'self';frame-ancestors 'self'"

#     }

#05RC
    if {([HTTP::header exists "Content-Security-Policy"])} {

		HTTP::header remove Content-Security-Policy

		HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com ;
		script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com connect.facebook.net jscdn.appier.net bat.bing.com img.scupio.com d.line-scdn.net www.techsolutions.com.tw https://cdn.taboola.com https://tagmanager.google.com *.googletagmanager.com ssl.google-analytics.com www.google-analytics.com googleads.g.doubleclick.net https://www.googleadservices.com https://www.google.com www.googleadservices.com ; 
		connect-src * 'unsafe-inline' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com *.google.com.tw  https://*.g.doubleclick.net ; 
		img-src 'self' data: bat.bing.com www.facebook.com *.c.appier.net img.scupio.com tr.line.me https://*.taboola.com https://ssl.gstatic.com *.google.com *.google.com.tw www.google.co.jp www.google.ca www.google.co.th  www.google.com.hk www.google.com.vn *.google-analytics.com *.googleapis.com *.googletagmanager.com  *.gstatic.com https://googleads.g.doubleclick.net  https://www.google.com g.doubleclick.net ; 
		style-src 'self' 'unsafe-inline' https://tagmanager.google.com  fonts.googleapis.com ; 
		object-src 'none' ; 
		frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* www.facebook.com www.googletagmanager.com bid.g.doubleclick.net img.scupio.com ; 
		font-src 'self' fonts.gstatic.com ; 
		frame-ancestors 'self'" 

    }

    if {!([HTTP::header exists "Content-Security-Policy"])} {

		HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com ;
		script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com connect.facebook.net jscdn.appier.net bat.bing.com img.scupio.com d.line-scdn.net www.techsolutions.com.tw https://cdn.taboola.com https://tagmanager.google.com *.googletagmanager.com ssl.google-analytics.com www.google-analytics.com googleads.g.doubleclick.net https://www.googleadservices.com https://www.google.com www.googleadservices.com ; 
		connect-src * 'unsafe-inline' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com *.google.com.tw  https://*.g.doubleclick.net ; 
		img-src 'self' data: bat.bing.com www.facebook.com *.c.appier.net img.scupio.com tr.line.me https://*.taboola.com https://ssl.gstatic.com *.google.com *.google.com.tw www.google.co.jp www.google.ca www.google.co.th  www.google.com.hk www.google.com.vn *.google-analytics.com *.googleapis.com *.googletagmanager.com  *.gstatic.com https://googleads.g.doubleclick.net  https://www.google.com g.doubleclick.net ; 
		style-src 'self' 'unsafe-inline' https://tagmanager.google.com  fonts.googleapis.com ; 
		object-src 'none' ; 
		frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* www.facebook.com www.googletagmanager.com bid.g.doubleclick.net img.scupio.com ; 
		font-src 'self' fonts.gstatic.com ; 
		frame-ancestors 'self'" 

    }


    if {!([HTTP::header exists "Strict-Transport-Security" ])} {
        HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubdomains; preload"
    }

    if {!([HTTP::header exists "X-Frame-Options" ])} {
        HTTP::header insert "X-Frame-Options" "sameorigin"
    }

    if {!([HTTP::header exists "X-Content-Type-Options"])} {
        HTTP::header insert "X-Content-Type-Options" "nosniff"
    }

    if {!([HTTP::header exists "Cache-Control"])} {
         HTTP::header insert Cache-Control "max-age=31536000"
    }
    if {!([HTTP::header exists "X-XSS-Protection"])} {
        HTTP::header replace "X-XSS-Protection" "1"
    }




}
}
ltm rule /eCash/iRule_eCash_header_prod_tmp {
when HTTP_RESPONSE_RELEASE {

  if { [HTTP::has_responded] } { return };
  set myValues [HTTP::cookie names]

  foreach mycookies $myValues {

    #2021&#28402;&#36879;&#28204;&#35430;,&#33509;&#26377;&#21839;&#38988;&#21487;&#31227;&#38500;  

    HTTP::cookie attribute $mycookies insert { SameSite=None}

  }

  #HTTP::header insert "Referrer-Policy"

   if {!([HTTP::header exists "Referrer-Policy"])} {

      HTTP::header insert "Referrer-Policy" "strict-origin-when-cross-origin"

    }


    if {!([HTTP::header exists "Permissions-Policy"])} {

        HTTP::header insert Permissions-Policy "camera=(), microphone=(), geolocation=()"

   }


#   if {([HTTP::header exists "Content-Security-Policy"])} {

#         HTTP::header remove Content-Security-Policy

#         HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:*;connect-src 'self' ;img-src 'self' data: ;style-src 'self' 'unsafe-inline'  ;object-src 'none' ;frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;font-src 'self';frame-ancestors 'self'"

#   }

#     if {!([HTTP::header exists "Content-Security-Policy"])} {

#         HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:*;connect-src 'self' ;img-src 'self' data: ;style-src 'self' 'unsafe-inline'  ;object-src 'none' ;frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* ;font-src 'self';frame-ancestors 'self'"

#     }

#05RC
    if {([HTTP::header exists "Content-Security-Policy"])} {
        HTTP::header remove Content-Security-Policy
        HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com ; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com connect.facebook.net jscdn.appier.net bat.bing.com img.scupio.com d.line-scdn.net www.techsolutions.com.tw https://cdn.taboola.com https://tagmanager.google.com *.googletagmanager.com ssl.google-analytics.com www.google-analytics.com googleads.g.doubleclick.net https://www.googleadservices.com https://www.google.com www.googleadservices.com ; connect-src * 'unsafe-inline' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com *.google.com.tw  https://*.g.doubleclick.net ; img-src 'self' data: bat.bing.com www.facebook.com *.c.appier.net img.scupio.com tr.line.me https://*.taboola.com https://ssl.gstatic.com *.google.com *.google.com.tw www.google.co.jp www.google.ca www.google.co.th  www.google.com.hk www.google.com.vn *.google-analytics.com *.googleapis.com *.googletagmanager.com  *.gstatic.com https://googleads.g.doubleclick.net  https://www.google.com g.doubleclick.net ; style-src 'self' 'unsafe-inline' https://tagmanager.google.com  fonts.googleapis.com ; object-src 'none' ; frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* www.facebook.com www.googletagmanager.com bid.g.doubleclick.net img.scupio.com ; font-src 'self' fonts.gstatic.com ; frame-ancestors 'self'"
    }

    if {!([HTTP::header exists "Content-Security-Policy"])} {
        HTTP::header insert Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com ; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* *.ctbcbank.com connect.facebook.net jscdn.appier.net bat.bing.com img.scupio.com d.line-scdn.net www.techsolutions.com.tw https://cdn.taboola.com https://tagmanager.google.com *.googletagmanager.com ssl.google-analytics.com www.google-analytics.com googleads.g.doubleclick.net https://www.googleadservices.com https://www.google.com www.googleadservices.com ; connect-src * 'unsafe-inline' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com *.google.com.tw  https://*.g.doubleclick.net ; img-src 'self' data: bat.bing.com www.facebook.com *.c.appier.net img.scupio.com tr.line.me https://*.taboola.com https://ssl.gstatic.com *.google.com *.google.com.tw www.google.co.jp www.google.ca www.google.co.th  www.google.com.hk www.google.com.vn *.google-analytics.com *.googleapis.com *.googletagmanager.com  *.gstatic.com https://googleads.g.doubleclick.net  https://www.google.com g.doubleclick.net ; style-src 'self' 'unsafe-inline' https://tagmanager.google.com  fonts.googleapis.com ; object-src 'none' ; frame-src 'self' 'unsafe-inline' 'unsafe-eval' https://localhost:* www.facebook.com www.googletagmanager.com bid.g.doubleclick.net img.scupio.com ; font-src 'self' fonts.gstatic.com ; frame-ancestors 'self'" 
    }


    if {!([HTTP::header exists "Strict-Transport-Security" ])} {
        HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubdomains; preload"
    }

    if {!([HTTP::header exists "X-Frame-Options" ])} {
        HTTP::header insert "X-Frame-Options" "sameorigin"
    }

    if {!([HTTP::header exists "X-Content-Type-Options"])} {
        HTTP::header insert "X-Content-Type-Options" "nosniff"
    }

    if {!([HTTP::header exists "Cache-Control"])} {
         HTTP::header insert Cache-Control "max-age=31536000"
    }
    if {!([HTTP::header exists "X-XSS-Protection"])} {
        HTTP::header replace "X-XSS-Protection" "1"
    }




}
}
ltm rule /eCash/iRule_eCash_redirect {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Ext "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#20225;&#26989;&#25910;&#20184;e-Cash &#24179;&#21488;&#31995;&#32113;&#32173;&#35703;&#20013;&#65292;&#35531;&#31245;&#24460;&#20877;&#35430;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
} 

when HTTP_REQUEST {
if { [HTTP::has_responded] } { return };
   #pool &#38283;&#21855;=0&#26178; 2022/06/24 by wenchin
# if { [active_members [LB::server pool]] == 0 } {
#       HTTP::respond 200 content $::html_content_Ext
# } 
# remove Range requests for CVE-2011-3192
    HTTP::header remove Range
    HTTP::header remove Request-Range

  if { not ([string tolower [HTTP::host]] starts_with "ecash.ctbcbank.com")}{
      #Replace the host header value with ecash.ctbcbank.com
      HTTP::header replace Host "ecash.ctbcbank.com"
  }


  if { ([HTTP::uri] starts_with "/PCMS/LoginIntra") || ([HTTP::uri] starts_with "/PCMS/LoginedIntraHome") || ([HTTP::uri] starts_with "/PCMSIntra/LoginIntra")}
  {
    HTTP::redirect "https://ecash.ctbcbank.com:8443/"
    # log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
        } else {
                if { [HTTP::uri] starts_with "/PCMS" } {
                    pool POOL_ECASH_AP
                    # log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
                } else {     
                            HTTP::redirect "https://ecash.ctbcbank.com/PCMS"
						   # if { [HTTP::has_responded] } { return };
                           # log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
          }   
  }

}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Ext
}
}
ltm rule /eCash/iRule_eCash_redirect_INTRA {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Ext "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#20225;&#26989;&#25910;&#20184;e-Cash &#24179;&#21488;&#31995;&#32113;&#32173;&#35703;&#20013;&#65292;&#35531;&#31245;&#24460;&#20877;&#35430;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
} 

when HTTP_REQUEST {
if { [HTTP::has_responded] } { return };
   #pool &#38283;&#21855;=0&#26178; 2022/06/24 by wenchin
# if { [active_members [LB::server pool]] == 0 } {
#       HTTP::respond 200 content $::html_content_Ext
# }
 # remove Range requests for CVE-2011-3192
    HTTP::header remove Range
    HTTP::header remove Request-Range

  if {  ([string tolower [HTTP::host]] starts_with "ecash.chinatrust.com.tw")}{
      #Replace the host header value with ecash.ctbcbank.com
      HTTP::redirect "https://ecash.ctbcbank.com/PCMS/index"
  }

  if { [HTTP::has_responded] } { return };
  if { ([HTTP::uri] starts_with "/PCMS/LoginIntra") || ([HTTP::uri] starts_with "/PCMS/LoginedIntraHome") || ([HTTP::uri] starts_with "/PCMSIntra/LoginIntra")}
  {
    HTTP::redirect "https://ecash.ctbcbank.com:8443/"
    # log local0. "[IP::remote_addr] [HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
   } else {
       if { [HTTP::uri] starts_with "/PCMS" } {
            pool POOL_ECASH_AP_INTRA
            # log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
          } else {     
            HTTP::redirect "https://ecash.ctbcbank.com/PCMS"
			#if { [HTTP::has_responded] } { return };
            #log local0. "[HTTP::uri] [HTTP::header Referer] [HTTP::cookie JESSIONID] to server [LB::server addr] port [LB::server port]"
          }   
  }   

}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Ext
}
}
ltm rule /eCash/iRule_eCash_shutdown {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Intra "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#20225;&#26989;&#25910;&#20184;e-Cash &#24179;&#21488;&#21450; &#20195;&#25910;&#20184;&#24460;&#21488;&#31649;&#29702;&#31995;&#32113; &#30446;&#21069;&#27491;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#20013;&#65292;</p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
} 

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Intra
}

when HTTP_REQUEST { 
   if { [active_members POOL_ECASH_AP ] < 1 } { HTTP::respond 200 content $::html_content_Intra} 
}
}
ltm rule /eCash/iRule_eCash_shutdown_EXT {
when RULE_INIT {
# Set an HTML response to sent to clients who make a request while the VIP is over the max connection count
  set ::html_content_Intra "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#12300;&#20225;&#26989;&#25910;&#20184;e-Cash&#24179;&#21488;&#12301;&#21450;&#12300;&#20195;&#25910;&#20184;&#24460;&#21488;&#31649;&#29702;&#31995;&#32113;&#12301;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#65292;&#26283;&#20572;&#20351;&#29992;&#12290;
 </p><p>&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351;&#20225;&#26989;&#25910;&#20184; e-Cash &#25964;&#21855;</p></body></html>"
}

when HTTP_REQUEST {
if { ( [IP::addr [IP::client_addr] equals 10.33.181.86] ) or ( [IP::addr [IP::client_addr] equals 10.33.117.83] ) or ( [IP::addr [IP::client_addr] equals 10.32.129.87] ) }   {
     pool POOL_ECASH_AP
	} else {
	       HTTP::respond 200 content $::html_content_Intra
	}  
}

when LB_FAILED {
    HTTP::respond 200 content $::html_content_Intra
}
}
ltm snat-translation /eCash/10.23.96.103 {
    address 10.23.96.103
    inherited-traffic-group true
    traffic-group /Common/traffic-group-1
}
ltm snat-translation /eCash/192.168.212.24 {
    address 192.168.212.24
    inherited-traffic-group true
    traffic-group /Common/traffic-group-1
}
ltm snatpool /eCash/SNAT_ECASH_INTRA {
    members {
        /eCash/192.168.212.24
    }
}
ltm snatpool /eCash/SNAT_ECASH_SMEAPP {
    members {
        /eCash/10.23.96.103
    }
}
ltm virtual /eCash/VS_ECASH_BA_INTRA_192.168.212.24_7007 {
    destination /eCash/192.168.212.24:7007
    ip-protocol tcp
    mask 255.255.255.255
    persist {
        /Common/cookie {
            default yes
        }
    }
    pool /eCash/POOL_ECASH_BA_INTRA
    profiles {
        /Common/HTTP_X_forward { }
        /Common/tcp { }
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /eCash/SNAT_ECASH_INTRA
        type snat
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual /eCash/VS_ECASH_EXT_175.184.243.77_443 {
    description ecash-new
    destination /Common/175.184.243.77:443
    ip-protocol tcp
    last-modified-time 2024-12-21:00:54:29
    mask 255.255.255.255
    persist {
        /Common/cookie_insert_ecash {
            default yes
        }
    }
    policies {
        /eCash/asm_auto_l7_policy__VS_ECASH_EXT_175.184.243.77_443 { }
    }
    pool /eCash/POOL_ECASH_AP
    profiles {
        /Common/eCash_SSL_CTBC {
            context clientside
        }
        /Common/websecurity { }
        /eCash/ASM_SP_eCash { }
        /eCash/HTTP_eCash_P { }
        /eCash/eCash_TCP { }
    }
    rules {
        /eCash/BLock_eCash_Strust2
        /eCash/iRule_eCash_redirect
        /eCash/iRule_eCash_shutdown
        /eCash/iRule_eCash_header_prod
        /Common/iRule_SlowAttack_Protection
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /eCash/SNAT_ECASH_INTRA
        type snat
    }
    translate-address enabled
    translate-port enabled
    vlans {
        /Common/IWEB_Vlan_2593
    }
    vlans-enabled
}
ltm virtual /eCash/VS_ECASH_INTRA_192.168.212.24_80 {
    destination /eCash/192.168.212.24:80
    ip-protocol tcp
    mask 255.255.255.255
    persist {
        /Common/cookie_insert_ecash {
            default yes
        }
    }
    profiles {
        /Common/tcp { }
        /eCash/HTTP_eCash_P { }
    }
    rules {
        /Common/iRule_Redirect_HTTPS
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual /eCash/VS_ECASH_INTRA_192.168.212.24_443 {
    destination /eCash/192.168.212.24:443
    ip-protocol tcp
    mask 255.255.255.255
    persist {
        /Common/cookie_insert_ecash {
            default yes
        }
    }
    policies {
        /eCash/asm_auto_l7_policy__VS_ECASH_INTRA_192.168.212.24_443 { }
    }
    pool /eCash/POOL_ECASH_AP_INTRA
    profiles {
        /Common/websecurity { }
        /eCash/ASM_SP_eCash { }
        /eCash/HTTP_eCash_P { }
        /eCash/eCash_Intra_TCP { }
        /eCash/eCash_SSL_CTBC {
            context clientside
        }
    }
    rules {
        /eCash/BLock_eCash_Strust2
        /eCash/iRule_eCash_redirect_INTRA
        /eCash/iRule_eCash_header_prod
        /Common/iRule_SlowAttack_Protection
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /eCash/SNAT_ECASH_INTRA
        type snat
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual /eCash/VS_ECASH_INTRA_192.168.212.24_8443 {
    destination /eCash/192.168.212.24:8443
    ip-protocol tcp
    mask 255.255.255.255
    persist {
        /Common/cookie_insert {
            default yes
        }
    }
    policies {
        /eCash/asm_auto_l7_policy__VS_ECASH_INTRA_192.168.212.24_8443 { }
    }
    pool /eCash/POOL_ECASH_AP
    profiles {
        /Common/websecurity { }
        /eCash/ASM_SP_eCash { }
        /eCash/HTTP_eCash_P { }
        /eCash/eCash_Intra_TCP { }
        /eCash/eCash_SSL_CTBC {
            context clientside
        }
    }
    rules {
        /eCash/BLock_eCash_Strust2
        /eCash/iRule_eCash_BD
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /eCash/SNAT_ECASH_INTRA
        type snat
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual /eCash/VS_ECASH_SMEAPP_175.184.240.187_443 {
    destination /Common/175.184.240.187:443
    ip-protocol tcp
    last-modified-time 2024-04-19:19:24:20
    mask 255.255.255.255
    persist {
        /Common/cookie_insert_sme {
            default yes
        }
    }
    policies {
        /eCash/asm_auto_l7_policy__VS_ECASH_SMEAPP_175.184.240.187_443 { }
    }
    pool /eCash/POOL_SB_MFP
    profiles {
        /Common/SME_PWA_SSL {
            context clientside
        }
        /Common/tcp { }
        /Common/websecurity { }
        /eCash/ASM_SP_SMEAPP { }
        /eCash/HTTP_X_Forward_SMEPWA { }
        /eCash/RW_ECASH_OCP { }
    }
    rules {
        /eCash/iRule_SME_ROUTER
        /eCash/iRule_SME_HEADER
        /eCash/iRule_SME_MFE_CORS
        /Common/iRule_SlowAttack_Protection
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /eCash/SNAT_ECASH_SMEAPP
        type snat
    }
    translate-address enabled
    translate-port enabled
    vlans {
        /Common/IWEB_Vlan_201
        /Common/IWEB_Vlan_2593
    }
    vlans-enabled
}
ltm virtual /eCash/VS_ECASH_SMEAPP_ext_175.184.240.187_18888 {
    destination /Common/175.184.240.187:18888
    ip-protocol tcp
    last-modified-time 2024-04-19:19:24:40
    mask 255.255.255.255
    persist {
        /Common/cookie_insert_sme {
            default yes
        }
    }
    pool /eCash/POOL_SB_MFP
    profiles {
        /Common/SME_PWA_SSL {
            context clientside
        }
        /Common/tcp { }
        /eCash/HTTP_X_Forward_SMEPWA { }
        /eCash/RW_ECASH_OCP { }
    }
    rules {
        /eCash/iRule_SME_ROUTER
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /eCash/SNAT_ECASH_SMEAPP
        type snat
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual /eCash/VS_eCash_AP_10.23.96.81_80 {
    description learn-ecash
    destination /eCash/10.23.96.81:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /eCash/POOL_eCash_AP_learn
    profiles {
        /Common/tcp { }
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        type automap
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /eCash/10.23.96.81 {
    address 10.23.96.81
    arp enabled
    icmp-echo enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}
ltm virtual-address /eCash/175.84.243.78 {
    address 175.84.243.78
    arp enabled
    icmp-echo enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}
ltm virtual-address /eCash/192.168.212.24 {
    address 192.168.212.24
    arp enabled
    icmp-echo enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}
ltm data-group internal /eCash/ECASH_ALLOW {
    type ip
}
ltm data-group internal /eCash/ECASH_MFE_CORS_ALLOW {
    records {
        \*.ctbcbank.com {
            data ctbcbank2
        }
        www.ctbcbank.com {
            data ctbcbank
        }
    }
    type string
}
ltm profile client-ssl /eCash/eCash_SSL_CTBC {
    alert-timeout 10
    allow-non-ssl disabled
    app-service none
    cache-size 262144
    cache-timeout 3600
    cert /Common/eCash_ctbcbank.tw_SSL_2024
    cert-key-chain {
        eCash_ctbcbank_TWCA_EV_uca2_0 {
            cert /Common/eCash_ctbcbank.tw_SSL_2024
            chain /Common/TWCA_EV_uca2.crt
            key /Common/eCash_ctbcbank.tw_SSL_2024
        }
    }
    chain /Common/TWCA_EV_uca2.crt
    cipher-group none
    ciphers ECDHE:!3DES:!SHA1:!CHACHA20-POLY1305
    defaults-from /Common/clientssl
    handshake-timeout 10
    inherit-ca-certkeychain true
    inherit-certkeychain false
    key /Common/eCash_ctbcbank.tw_SSL_2024
    mod-ssl-methods disabled
    options { dont-insert-empty-fragments no-tlsv1.3 no-tlsv1.1 no-sslv3 no-tlsv1 }
    passphrase none
    proxy-ssl disabled
    renegotiate-max-record-delay indefinite
    renegotiate-period indefinite
    renegotiate-size 1000mb
    renegotiation enabled
    secure-renegotiation require
    server-name none
    session-ticket disabled
    sni-default false
    sni-require false
    strict-resume disabled
    unclean-shutdown enabled
}
ltm profile http /eCash/HTTP_X_Forward_SMEPWA {
    app-service none
    defaults-from /Common/http
    encrypt-cookie-secret $M$Rt$5FuF8cIiUCNUabp1P0ySsg==
    insert-xforwarded-for enabled
    proxy-type reverse
}
ltm profile http /eCash/HTTP_eCash_P {
    accept-xff disabled
    app-service none
    defaults-from /Common/http
    encrypt-cookies none
    enforcement {
        max-header-count 64
        max-header-size 32768
        max-requests 0
        pipeline allow
        unknown-method allow
    }
    fallback-host none
    fallback-status-codes none
    header-erase none
    header-insert "WL-Proxy-SSL: true"
    insert-xforwarded-for enabled
    lws-separator none
    lws-width 80
    oneconnect-transformations enabled
    proxy-type reverse
    redirect-rewrite matching
    request-chunking sustain
    response-chunking sustain
    response-headers-permitted none
    via-request preserve
    via-response preserve
    xff-alternative-names none
}
ltm profile rewrite /eCash/RW_ECASH_OCP {
    app-service none
    bypass-list none
    client-caching-type cache-css-js
    defaults-from /Common/rewrite
    java-ca-file /Common/ca-bundle.crt
    java-crl none
    java-sign-key /Common/default.key
    java-sign-key-passphrase-encrypted $M$Xw$sDgARPLLEtNEY9blulwjwA==
    java-signer /Common/default.crt
    location-specific false
    request {
        insert-xforwarded-for enabled
        insert-xforwarded-host enabled
        insert-xforwarded-proto enabled
        rewrite-headers enabled
    }
    response {
        rewrite-content enabled
        rewrite-headers enabled
    }
    rewrite-list none
    rewrite-mode uri-translation
    split-tunneling false
    uri-rules {
        uri_1658519152649 {
            client {
                host smeapp.ctbcbank.com
                path /MFE/
                scheme https
            }
            server {
                host ecash-api-3scale-apicast-production.apps.scp01.ctbcbank.com
                path /
                scheme http
            }
        }
        uri_1639966350183 {
            client {
                path //none//none/SB/
            }
            server {
                host ecash-api-3scale-apicast-production.apps.scp01.ctbcbank.com
                path /SB/
                scheme http
            }
        }
    }
}
ltm profile tcp /eCash/eCash_Intra_TCP {
    abc enabled
    ack-on-push enabled
    app-service none
    close-wait-timeout 5
    cmetrics-cache enabled
    congestion-control high-speed
    defaults-from /Common/tcp-legacy
    deferred-accept disabled
    delay-window-control disabled
    delayed-acks enabled
    dsack disabled
    ecn disabled
    fin-wait-timeout 5
    idle-timeout 3600
    init-cwnd 0
    init-rwnd 0
    ip-tos-to-client 0
    keep-alive-interval 1800
    limited-transmit enabled
    link-qos-to-client 0
    max-retrans 8
    md5-signature disabled
    md5-signature-passphrase none
    nagle disabled
    pkt-loss-ignore-burst 0
    pkt-loss-ignore-rate 0
    proxy-buffer-high 49152
    proxy-buffer-low 32768
    proxy-mss disabled
    proxy-options disabled
    receive-window-size 65535
    reset-on-timeout enabled
    selective-acks enabled
    selective-nack disabled
    send-buffer-size 65535
    slow-start enabled
    syn-max-retrans 3
    syn-rto-base 0
    time-wait-recycle enabled
    time-wait-timeout 2000
    timestamps enabled
    verified-accept disabled
    zero-window-timeout 20000
}
ltm profile tcp /eCash/eCash_TCP {
    abc enabled
    ack-on-push enabled
    app-service none
    close-wait-timeout 5
    cmetrics-cache enabled
    congestion-control high-speed
    defaults-from /Common/tcp-legacy
    deferred-accept disabled
    delay-window-control disabled
    delayed-acks enabled
    dsack disabled
    ecn disabled
    fin-wait-timeout 5
    idle-timeout 3600
    init-cwnd 0
    init-rwnd 0
    ip-tos-to-client 0
    keep-alive-interval 1800
    limited-transmit enabled
    link-qos-to-client 0
    max-retrans 8
    md5-signature disabled
    md5-signature-passphrase none
    nagle disabled
    pkt-loss-ignore-burst 0
    pkt-loss-ignore-rate 0
    proxy-buffer-high 49152
    proxy-buffer-low 32768
    proxy-mss disabled
    proxy-options disabled
    receive-window-size 65535
    reset-on-timeout enabled
    selective-acks enabled
    selective-nack disabled
    send-buffer-size 65535
    slow-start enabled
    syn-max-retrans 3
    syn-rto-base 0
    time-wait-recycle enabled
    time-wait-timeout 2000
    timestamps enabled
    verified-accept disabled
    zero-window-timeout 20000
}
security bot-defense asm-profile /eCash/ASM_SP_SMEAPP {
    app-service none
}
security bot-defense asm-profile /eCash/ASM_SP_eCash {
    app-service none
}
sys file ssl-cert /eCash/eCash_ctbcbank_SSL_2019.crt {
    cache-path /config/filestore/files_d/eCash_d/certificate_d/:eCash:eCash_ctbcbank_SSL_2019.crt_88806_1
    revision 1
}
sys file ssl-key /eCash/eCash_ctbcbank_SSL_2019.key {
    cache-path /config/filestore/files_d/eCash_d/certificate_key_d/:eCash:eCash_ctbcbank_SSL_2019.key_88800_1
    revision 1
}
