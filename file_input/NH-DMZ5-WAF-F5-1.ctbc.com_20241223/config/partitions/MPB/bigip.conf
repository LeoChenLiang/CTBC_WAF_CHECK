#TMSH-VERSION: 17.1.1.3

asm policy /MPB/SP_MPB {
    active
    encoding utf-8
}
ltm node /MPB/10.23.40.150 {
    address 10.23.40.150
}
ltm node /MPB/10.23.40.151 {
    address 10.23.40.151
}
ltm node /MPB/10.23.40.152 {
    address 10.23.40.152
}
ltm node /MPB/10.23.40.153 {
    address 10.23.40.153
}
ltm node /MPB/10.243.136.49 {
    address 10.243.136.49
}
ltm node /MPB/10.243.136.50 {
    address 10.243.136.50
}
ltm node /MPB/10.243.136.204 {
    address 10.243.136.204
}
ltm node /MPB/10.243.136.205 {
    address 10.243.136.205
}
ltm node /MPB/10.243.136.206 {
    address 10.243.136.206
}
ltm node /MPB/10.243.136.207 {
    address 10.243.136.207
}
ltm node /MPB/10.243.136.208 {
    address 10.243.136.208
}
ltm node /MPB/10.243.136.209 {
    address 10.243.136.209
}
ltm node /MPB/10.243.136.210 {
    address 10.243.136.210
}
ltm node /MPB/10.243.136.211 {
    address 10.243.136.211
}
ltm node /MPB/10.243.136.242 {
    address 10.243.136.242
}
ltm node /MPB/10.243.136.243 {
    address 10.243.136.243
}
ltm node /MPB/10.243.136.244 {
    address 10.243.136.244
}
ltm node /MPB/10.243.136.245 {
    address 10.243.136.245
}
ltm policy /MPB/asm_auto_l7_policy__VS_MPB_F5_DMZ {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /MPB/SP_MPB
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /MPB/asm_auto_l7_policy__VS_MPB_F5_DMZ_443 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /MPB/SP_MPB
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /MPB/asm_auto_l7_policy__VS_MPB_F5_DMZ_9443_Source {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /MPB/SP_MPB
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm policy /MPB/asm_auto_l7_policy__VS_MPB_WEB_9080 {
    controls { asm }
    requires { http }
    rules {
        default {
            actions {
                1 {
                    asm
                    enable
                    policy /MPB/SP_MPB
                }
            }
            ordinal 1
        }
    }
    strategy /Common/first-match
}
ltm pool /MPB/POOL_MPB {
    members {
        /MPB/10.23.40.152:18085 {
            address 10.23.40.152
        }
        /MPB/10.23.40.153:18085 {
            address 10.23.40.153
        }
    }
    monitor /Common/tcp and /MPB/MPB_WEB_MONITOR
}
ltm pool /MPB/POOL_MPB_EM_WEB_18066 {
    members {
        /MPB/10.23.40.152:18066 {
            address 10.23.40.152
        }
        /MPB/10.23.40.153:18066 {
            address 10.23.40.153
        }
    }
    monitor /Common/tcp
}
ltm pool /MPB/POOL_MPB_ONLINE {
    description MPB線上綁卡
    members {
        /MPB/10.23.40.152:18068 {
            address 10.23.40.152
            description MPB線上綁卡
        }
        /MPB/10.23.40.153:18068 {
            address 10.23.40.153
            description MPB線上綁卡
        }
    }
    monitor /Common/tcp
}
ltm pool /MPB/POOL_MPB_ONLINE_QUERY {
    description MPB線上綁卡交易查詢
    members {
        /MPB/10.23.40.152:18070 {
            address 10.23.40.152
        }
        /MPB/10.23.40.153:18070 {
            address 10.23.40.153
            description MPB線上綁卡交易查詢
        }
    }
    monitor /Common/tcp
}
ltm pool /MPB/POOL_MPB_ONLINE_TRANS {
    description MPB線上交易
    members {
        /MPB/10.23.40.152:18069 {
            address 10.23.40.152
            description MPB線上交易
            monitor /Common/tcp
        }
        /MPB/10.23.40.153:18069 {
            address 10.23.40.153
            description MPB線上交易
        }
    }
    monitor /Common/tcp
}
ltm rule /MPB/MPB_PERSIST {
when RULE_INIT {
  set static::debug 1
}

when CLIENT_ACCEPTED {
  if { $static::debug } {
    set client [IP::client_addr]:[TCP::client_port]
  }
}

when HTTP_RESPONSE {
  if { [HTTP::cookie exists "JSESSIONID"] } {
    set jsessionid [HTTP::cookie "JSESSIONID"]
    persist add uie $jsessionid 1800
    if { $static::debug } {
      #log local0. "NEW PERSIST ENTRY client>$client< JSESSIONID>$jsessionid<"
    }
  }
}

when HTTP_REQUEST {
  set jsessionid ""
  set cookie_id ""
  set uri [HTTP::uri]
  set uri_id [findstr $uri "jsessionid=" 11 "?"]
  if { [HTTP::cookie exists "JSESSIONID"] } {
    set cookie_id [HTTP::cookie "JSESSIONID"]
  }
  if { $cookie_id ne "" } {
    set jsessionid $cookie_id
  } elseif { $uri_id ne "" } {
    set jsessionid $uri_id
  }
  if { $jsessionid ne "" } {
    persist uie $jsessionid 1800
  }
  if { $static::debug } {
    set table ""
    if { $jsessionid ne "" } {
      set table [persist lookup uie $jsessionid]
    }
    if { $table eq "" } {
      #log local0. "client>$client< uri>$uri< cookie_id>$cookie_id< uri_id>$uri_id< JSESSIONID>$jsessionid< table>null<"
    } else {
      #log local0. "client>$client< uri>$uri< cookie_id>$cookie_id< uri_id>$uri_id< JSESSIONID>$jsessionid< table>[lindex $table 0] [lindex $table 1] [lindex $table 2]<"
    }
  }
}

when LB_SELECTED {
  if { $static::debug } {
    set server [LB::server addr]:[LB::server port]
    #log local0. "client>$client< server>$server<"
  }
}

when LB_FAILED {
  if { $static::debug } {
    if { $jsessionid ne "" } {
      if { $table ne "" } {
        #log local0. "client>$client< JSESSIONID>$jsessionid< table>[lindex $table 0] [lindex $table 1] [lindex $table 2]<"
      } else {
        #log local0. "client>$client< JSESSIONID>$jsessionid< table>null<"
      }
    } else {
      #log local0. "client>$client< JSESSIONID>null< table>null<"
    }
  }
  if { $jsessionid ne "" } { persist delete uie $jsessionid }
  if { $table ne "" } { LB::reselect pool [lindex $table 0] }
}
}
ltm rule /MPB/iRule_MPB_COOKIE_SECURE {
when HTTP_RESPONSE {
    foreach aCookie [HTTP::cookie names] {
        HTTP::cookie secure $aCookie enable
        HTTP::cookie httponly $aCookie enable
    }

    if {![HTTP::header exists "X-Frame-Options"] } { 
        HTTP::header insert "X-Frame-Options" "DENY"
    }

    #.	X-XSS-Protection
    #(1)	&#29992;&#36884;&#65306;&#22914;&#26524;&#28687;&#35261;&#22120;&#20597;&#28204;&#21040; XSS &#30340;&#25915;&#25802;&#65292;&#26371;&#26681;&#25818;&#35373;&#32622;&#30340;&#23660;&#24615;&#20570;&#19981;&#21516;&#30340;&#21453;&#25033;
    #(2)	&#20351;&#29992;&#31684;&#20363;&#65306;
    #       X-XSS-Protection: 1; mode=block
    #       &#38283;&#21855; XSS &#36942;&#28670;&#21151;&#33021;&#65292;&#22914;&#26524;&#20597;&#28204;&#21040; XSS &#25915;&#25802;&#30340;&#35441;&#65292;&#28687;&#35261;&#22120;&#19981;&#26371;&#25226;&#32178;&#38913;&#32102;&#28210;&#26579;&#20986;&#20358;
    #(3)	&#28687;&#35261;&#22120;&#65306;&#38500;&#20102;Firefox&#65292;&#20854;&#20182;&#37117;&#26377;&#25903;&#25588;
    if {![HTTP::header exists "X-XSS-Protection"] } { 
        HTTP::header insert "X-XSS-Protection" "1; mode=block" 
    } 

    if {![HTTP::header exists "Cache-Control"] } { 
        HTTP::header insert "Cache-Control" "no-store, max-age=0" 
    }

    if {![HTTP::header exists "Content-Security-Policy"] } { 
        HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'"
    }

    if {![HTTP::header exists "Strict-Transport-Security"] } { 
        HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubDomains;" 
    }

    if {![HTTP::header exists "X-Content-Type-Options"] } { 
        HTTP::header insert "X-Content-Type-Options" "nosniff" 
    }

    if {!([ HTTP::header exists "Referrer-Policy" ])} { 
        HTTP::header insert "Referrer-Policy" "strict-origin-when-cross-origin"    
    }

    if {![HTTP::header exists "Permissions-Policy"] } { 
        HTTP::header insert "Permissions-Policy" "microphone=(),midi=()"
    }

    if {[HTTP::header exists "Location"] } { 
	    if {[class match [HTTP::header values "Location"] contains MPB_AP_SERVER_IP]}{
		    HTTP::header remove "Location" 
	    }
    }

    if {[HTTP::header exists "Location"] } { 
	    if {[class match [HTTP::header values "Location"] contains MPB_AP_SERVER_IP]}{
            HTTP::header remove "Location" 
	    }
    }
}
}
ltm rule /MPB/iRule_MPB_Parsing_Online_Request_Data {
when HTTP_REQUEST {
set usessl 0

  if { [HTTP::uri] contains "/binding/" } {
    HTTP::header insert X-Forwarded-For [IP::remote_addr]
    pool POOL_MPB_ONLINE 
    set usessl 0

  } elseif { [HTTP::uri] contains "/trans/" } {
    HTTP::header insert X-Forwarded-For [IP::remote_addr]
    pool POOL_MPB_ONLINE_TRANS
    set usessl 0

  } elseif { [HTTP::uri] contains "/query/" } {
    HTTP::header insert X-Forwarded-For [IP::remote_addr]
    pool POOL_MPB_ONLINE_QUERY
    set usessl 0

  } elseif { [HTTP::uri] contains "/graphql/" } {
    HTTP::header insert X-Forwarded-For [IP::remote_addr]
    pool POOL_MPB_ONLINE_QUERY
    set usessl 0

  } else {
    pool POOL_MPB
    set usessl 1
  }
}
when SERVER_CONNECTED {
  if { $usessl == 0 } {
    SSL::disable serverside
  }
}
}
ltm rule /MPB/iRule_MPB_Parsing_Request_Data {
when HTTP_REQUEST {
  if {[HTTP::method] eq "POST"}{
    # Trigger collection for up to 1MB of data
    if {[HTTP::header "Content-Length"] ne "" && [HTTP::header "Content-Length"] <= 1048576}{
      set content_length [HTTP::header "Content-Length"]
    } else {
      set content_length 1048576
    }
    # Check if $content_length is not set to 0
    if { $content_length > 0} {
      HTTP::collect $content_length
    }
  }
}
when HTTP_REQUEST_DATA {
  set poolNum [class search -value MPB_POOL_CONTROL equals POOL_NUM]
  set maintain [class search -value MPB_POOL_CONTROL equals IS_MAINTAIN]
  #Parsing JSON
  if {($maintain equals "Y")}{
    if {[matchclass [HTTP::payload] contains MPB_FILTER_STORE]}{
        if {($poolNum  equals "1")}{
            node 10.23.40.152 18085
        }
        else {
            node 10.23.40.153 18085
        }
    } else {
        if {($poolNum  equals "1")}{
            node 10.23.40.153 18085
        }
        else {
            node 10.23.40.152 18085
        }
    }
  }
  if {($maintain equals "P")}{
        if {[matchclass [HTTP::payload] contains MPB_FILTER_APIUSERID]}{
                node 10.23.40.152 18085
        }
        else {
                node 10.23.40.153 18085
        }
  }
}
}
ltm rule /MPB/iRule_MPB_Parsing_Request_Data_Pilot {
when HTTP_REQUEST {
	if {[HTTP::method] eq "POST"}{
		#Trigger collection for up to 1MB of data
		if {[HTTP::header "Content-Length"] ne "" && [HTTP::header "Content-Length"] <=1048576}{
			set content_length [HTTP::header "Content-Length"]
		} else {
			set content_length 1048576
		}
		# Check if $content_length is not set to 0
		if { $content_length > 0} {
			HTTP::collect $content_length
		}
	}
}
when HTTP_REQUEST_DATA {
	set poolNum [class search -value MPB_POOL_CONTROL equals POOL_NUM]
	set maintain [class search -value MPB_POOL_CONTROL equals IS_MAINTAIN]
	#Parsing JSON
	if {($maintain equals "Y")}{
		if {[matchclass [HTTP::payload] contains MPB_FILTER_STORE]}{	
			pool POOL_MPB	
		} 
		else {
			pool POOL_MPB_NEW
		}
	}
	if {($maintain equals "P")}{
	    if {[matchclass [HTTP::payload] contains MPB_FILTER_APIUSERID]}{
		    pool POOL_MPB
	    }
	    else {
		    pool POOL_MPB_NEW
	    }
    }
}
}
ltm rule /MPB/iRule_inob_crmm_restrict {
when HTTP_REQUEST {
    if { [HTTP::uri] starts_with "/crmm" || [HTTP::uri] starts_with "/api/crmm"} {
        if { [class match [IP::client_addr] equals "INOB_IP_WHITE_LIST"] } {
            pool POOL_INOB_SLB
        }
    }
}
}
ltm rule /MPB/iRule_inob_ip_white_list {
when CLIENT_ACCEPTED {
    if { !([class match [IP::client_addr] eq INOB_IP_WHITE_LIST]) } {
        drop
    }
}
}
ltm rule /MPB/iRule_inob_slb_dispatcher {
when CLIENT_ACCEPTED {
    if { ([class match [IP::client_addr] eq INOB_IP_WHITE_LIST]) } {
		SSL::disable serverside
        pool POOL_INOB_SLB
    }
}
}
ltm rule /MPB/iRule_mpb_cpcob_Block_HTTP_TRACE {
when HTTP_REQUEST {
	if { [HTTP::has_responded] } { return };
    if { [HTTP::method] equals "TRACE" } {
        log local0. "Forbidden HTTP method ([HTTP::method]) attempted by [IP::client_addr]"
        reject
    }
	if { [HTTP::has_responded] } { return };
    if {[string tolower [HTTP::method]] contains "trace"}{
        log local0. "Forbidden HTTP method ([HTTP::method]) attempted by [IP::client_addr]"
        reject
    }
}
}
ltm rule /MPB/iRule_mpb_cpcob_Dispatch {
when RULE_INIT {
    #&#32173;&#35703;&#38913;HTML
    set ::ma_content_mpb_cpcob "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><meta http-equiv=\"Cache-Control\" content=\"no-store, no-cache, private, must-revalidate, max-age=0\"><meta http-equiv=\"Pragma\" content=\"no-cache\"><meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'self'; img-src 'self'; child-src 'none'; script-src 'self'; object-src 'self'; style_src-src 'self'; font-src 'self'; media-src 'self'; frame-src 'self'; connect-src 'self';\"></head><body style=\"font-family:Microsoft JhengHei; text-align: center; padding: 0; margin: 0; height: 100%;\"><div style=\"background-color: #007c7d;\"><img style=\"width:200px;\" src=\"https://ob.ctbcbank.com/mgm/image/Logo.png\"></div><div style=\"text-align: center; border:0px solid black; \"><p style=\"padding:40px 0 20px 0;\"><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><div style=\"width:60%; text-align: left; margin:0 auto; padding:0 0 0 30px; border:0px solid red;\"><p><b>&#35242;&#24859;&#30340;&#23458;&#25142;&#24744;&#22909;&#65292;</b></p><p style=\"line-height: 30px;\">&#28858;&#25345;&#32396;&#25552;&#20379;&#33391;&#22909;&#30340;&#26381;&#21209;&#21697;&#36074;&#65292;&#26412;&#34892;&#27491;&#36914;&#34892;&#20363;&#34892;&#24615;&#31995;&#32113;&#32173;&#35703;&#65292;&#27492;&#26178;&#27573;&#23559;&#26283;&#20572;&#26381;&#21209;&#65292;&#36896;&#25104;&#19981;&#20415;&#20043;&#34389;&#25964;&#35531;&#35211;&#35538;&#12290;</p></div></div><div style=\"position:fixed; width:100%; text-align: center; bottom:0; padding:0 0 20px 0 \"></div></body></html>"
    set ::ma_content_fsv "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><meta http-equiv=\"Cache-Control\" content=\"no-store, no-cache, private, must-revalidate, max-age=0\"><meta http-equiv=\"Pragma\" content=\"no-cache\"><meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'self'; img-src 'self'; child-src 'none'; script-src 'self'; object-src 'self'; style_src-src 'self'; font-src 'self'; media-src 'self'; frame-src 'self'; connect-src 'self';\"></head><body style=\"font-family:Microsoft JhengHei; text-align: center; padding: 0; margin: 0; height: 100%;\"><div style=\"background-color: #007c7d;\"><img style=\"width:200px;\" src=\"https://ob.ctbcbank.com/mgm/image/Logo.png\"></div><div style=\"text-align: center; border:0px solid black; \"><p style=\"padding:40px 0 20px 0;\"><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><div style=\"width:60%; text-align: left; margin:0 auto; padding:0 0 0 30px; border:0px solid red;\"><p><b>&#34892;&#25919;&#38498;&#25391;&#33288;&#20116;&#20493;&#21048;&#23578;&#26410;&#38283;&#25918;&#32129;&#23450;&#65292;&#35531;&#24744;&#31245;&#24460;&#20877;&#35430;&#65281;</p></div></div><div style=\"position:fixed; width:100%; text-align: center; bottom:0; padding:0 0 20px 0 \"></div></body></html>"
    set ::ma_content_mpb_inob_blocked_error "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><meta http-equiv=\"Cache-Control\" content=\"no-store, no-cache, private, must-revalidate, max-age=0\"><meta http-equiv=\"Pragma\" content=\"no-cache\"><meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'self'; img-src 'self'; child-src 'none'; script-src 'self'; object-src 'self'; style_src-src 'self'; font-src 'self'; media-src 'self'; frame-src 'self'; connect-src 'self';\"></head><body style=\"font-family:Microsoft JhengHei; text-align: center; padding: 0; margin: 0; height: 100%;\"><div style=\"background-color: #007c7d;\"><img style=\"width:200px;\" src=\"https://ob.ctbcbank.com/mgm/image/Logo.png\"></div><div style=\"text-align: center; border:0px solid black; \"><p style=\"padding:40px 0 20px 0;\"><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><div style=\"width:60%; text-align: left; margin:0 auto; padding:0 0 0 30px; border:0px solid red;\"><p><b>&#35242;&#24859;&#30340;&#23458;&#25142;&#24744;&#22909;&#65292;</b></p><p style=\"line-height: 30px;\">&#28858;&#25345;&#32396;&#25552;&#20379;&#33391;&#22909;&#30340;&#26381;&#21209;&#21697;&#36074;&#65292;&#26412;&#34892;&#27491;&#36914;&#34892;&#20363;&#34892;&#24615;&#31995;&#32113;&#32173;&#35703;&#65292;&#27492;&#26178;&#27573;&#23559;&#26283;&#20572;&#26381;&#21209;&#65292;&#36896;&#25104;&#19981;&#20415;&#20043;&#34389;&#25964;&#35531;&#35211;&#35538;&#12290;</p></div></div><div style=\"position:fixed; width:100%; text-align: center; bottom:0; padding:0 0 20px 0 \"></div></body></html>"
    set ::ma_content_fsv_expired "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"></head><body>&#25391;&#33288;&#20116;&#20493;&#21048;&#27963;&#21205;&#24050;&#32080;&#26463;&#12290;<br/>&#38283;&#25918;&#30331;&#37636;&#26399;&#38291;&#28858;110&#24180;9&#26376;22&#26085;&#36215;&#33267;111&#24180;4&#26376;30&#26085;&#27490;&#12290;<br/>&#32047;&#31309;&#28040;&#36027;&#26399;&#38291;&#28858;110&#24180;10&#26376;8&#26085;&#36215;&#33267;111&#24180;4&#26376;30&#26085;&#27490;&#12290;<br/>&#27442;&#26597;&#35426;&#30456;&#38364;&#36039;&#35338;&#65292;&#35531;&#33267;&#34892;&#25919;&#38498;&#12304;&#25391;&#33288;&#20116;&#20493;&#21048;&#12305;&#32178;&#38913;(<a href='https://5000.gov.tw/'>https://5000.gov.tw/</a>)&#26597;&#35426;&#30906;&#35469;&#65292;&#25110;&#33268;&#38651;&#34892;&#25919;&#38498;&#12304;&#25391;&#33288;&#20116;&#20493;&#21048;&#12305;1988&#23560;&#32218;&#65292;&#35613;&#35613;&#12290;</body></html>"

}


 when HTTP_REQUEST {
	if { [HTTP::has_responded] } { return };
    persist cookie

    if {[HTTP::uri] starts_with "/fsv" || [HTTP::uri] starts_with "/api/fsv"} {
        set now [clock seconds]
        set fmt "%Y-%m-%d"
        set ymd10 "[clock format $now -format $fmt]"
        set deadline "2022-05-01 00:00:00"
        if {($deadline ne "") && ($now >= [clock scan $deadline])} {
            HTTP::respond 200 content $::ma_content_fsv_expired "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
        }
    }


	if { !([class match [IP::client_addr] eq INOB_IP_WHITE_LIST]) } {

		if { [HTTP::has_responded] } { return };
		if { [HTTP::uri] contains "/actuator" || [HTTP::uri] starts_with "/actuator" || [HTTP::uri] ends_with "/actuator"} {
			HTTP::respond 404 content $::ma_content_mpb_inob_blocked_error "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		}
        #HTTP::uri&#19981;&#33021;&#35712;&#21462;#,&#22240;&#28858;&#28687;&#35261;&#22120;&#36942;&#28670;&#20102;
		if { [HTTP::has_responded] } { return };
		if { [HTTP::uri] starts_with "/api/middle_auth"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/api/middle_prize"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/api/middle_record"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/auth/backend"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/cbp-sut"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/mgm/qrcodeDraft"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/mgm/activityDraft"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} elseif { [HTTP::uri] starts_with "/backend"} {
			HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
		} else {

		}
	}else {

	}
}

when LB_FAILED {
    HTTP::respond 200 content $::ma_content_mpb_cpcob "Strict-Transport-Security" "max-age=31536000; includeSubDomains" "X-Frame-Options" "SAMEORIGIN" "X-Content-Type-Options" "nosniff" "Content-Type" "text/html" "X-XSS-Protection" "1; mode=block" "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self' ;" "Referrer-Policy" "strict-origin-when-cross-origin" "Permissions-Policy" "camera=(), microphone=(), geolocation=()" "Cache-Control" "no-store, max-age=0"
}
}
ltm rule /MPB/iRule_mpb_cpcob_REMOVE_HEADER {
when HTTP_RESPONSE {

    HTTP::header remove Server

    foreach header_name [HTTP::header names] {

       #X-Frame-Options
       #&#20027;&#27231;&#23553;&#21253;&#27161;&#38957;&#36039;&#35338;&#27945;&#28431;&#20027;&#27231;&#12289;&#22871;&#20214;&#29256;&#26412; X-Powered-By
       #X-&#38283;&#38957;&#30340;&#37117;&#26371;&#34987;&#31227;&#25481;
       if {[string match -nocase X-* $header_name]}{
           HTTP::header remove $header_name
       }
    }

    #&#31105;&#27490;&#38002;&#23884;&#25110;&#21487;&#20801;&#35377;&#26576;&#32178;&#31449;&#21487;&#38002;&#23884;&#31995;&#32113;&#38913;&#38754;&#35373;&#23450;
    #&#24453;&#30906;&#35469;allow&#30340;&#32178;&#31449;&#20877;&#21855;&#29992;
    HTTP::header insert "X-Frame-Options" "SAMEORIGIN"

    #1.	Strict-Transport-Security
    #(1)	&#29992;&#36884;&#65306;&#24375;&#36843;&#29992;&#25142;&#20351;&#29992; HTTPS&#65292;&#38450;&#31684; MITM &#25915;&#25802;
    #(2)	&#20351;&#29992;&#31684;&#20363;&#65306;
    #       Strict-Transport-Security: max-age=31536000; includeSubDomains
    #       &#24375;&#21046; HTTPS&#36681;&#25563;&#65292;&#26377;&#25928;&#26399;&#38291;&#28858;&#19968;&#24180;
    #(3)	&#28687;&#35261;&#22120;&#65306;&#22823;&#22810;&#26377;&#25903;&#25588;
    if {![HTTP::header exists "Strict-Transport-Security"] } { 
       HTTP::header insert "Strict-Transport-Security" "max-age=31536000; includeSubDomains" 
    }

    #3.	X-XSS-Protection
    #(1)	&#29992;&#36884;&#65306;&#22914;&#26524;&#28687;&#35261;&#22120;&#20597;&#28204;&#21040; XSS &#30340;&#25915;&#25802;&#65292;&#26371;&#26681;&#25818;&#35373;&#32622;&#30340;&#23660;&#24615;&#20570;&#19981;&#21516;&#30340;&#21453;&#25033;
    #(2)	&#20351;&#29992;&#31684;&#20363;&#65306;
    #       X-XSS-Protection: 1; mode=block
    #       &#38283;&#21855; XSS &#36942;&#28670;&#21151;&#33021;&#65292;&#22914;&#26524;&#20597;&#28204;&#21040; XSS &#25915;&#25802;&#30340;&#35441;&#65292;&#28687;&#35261;&#22120;&#19981;&#26371;&#25226;&#32178;&#38913;&#32102;&#28210;&#26579;&#20986;&#20358;
    #(3)	&#28687;&#35261;&#22120;&#65306;&#38500;&#20102;Firefox&#65292;&#20854;&#20182;&#37117;&#26377;&#25903;&#25588;
    if {![HTTP::header exists "X-XSS-Protection"] } { 
        HTTP::header insert "X-XSS-Protection" "1; mode=block" 
    } 

    #4.	X-Content-Type-Options
    #(1)	&#29992;&#36884;&#65306;&#36991;&#20813;&#35712;&#21462;&#26410;&#30693;&#25110;&#26159;&#20551;&#36896;&#30340; MIME &#36039;&#26009;&#39006;&#22411;
    #(2)	&#20351;&#29992;&#31684;&#20363;&#65306;
    #       X-Content-Type-Options: nosniff
    #       &#28687;&#35261;&#22120;&#19981;&#26371;&#20219;&#24847;&#22519;&#34892; CSS  &#38500;&#38750;MIME &#22411;&#24907;&#28858;text/css
    #(3)	&#28687;&#35261;&#22120;&#65306;&#38500;&#20102;Safari&#65292;&#20854;&#20182;&#37117;&#26377;&#25903;&#25588;
    if {![HTTP::header exists "X-Content-Type-Options"] } { 
       HTTP::header insert "X-Content-Type-Options" "nosniff" 
    }

    #5.	Referrer-Policy
    #(1)	&#29992;&#36884;&#65306; &#35352;&#37636;&#19978;&#19968;&#20491;&#28687;&#35261;&#30340;&#32178;&#22336;
    #(2)	&#20351;&#29992;&#31684;&#20363;&#65306;
    #       Referrer-Policy: no-referrer-when-downgrade
    #       &#21482;&#26377;&#22312; HTTPS&#61664;HTTPS &#20043;&#38291;&#25165;&#26371;&#34987;&#35352;&#37636;&#19979;&#20358;
    #(3)	&#28687;&#35261;&#22120;&#65306;&#22823;&#22810;&#26377;&#25903;&#25588;
    if {![HTTP::header exists "Referrer-Policy"] } { 
        HTTP::header insert "Referrer-Policy" "strict-origin-when-cross-origin"
    }  

    #6.	Feature-Policy
    #(1)	&#29992;&#36884;&#65306;&#21855;&#29992;&#21644;&#31105;&#29992;&#21508;&#31278;&#28687;&#35261;&#22120;&#21151;&#33021;&#21644;API
    #(2)	&#21151;&#33021;&#21015;&#34920;&#21487;&#21443;&#32771;&#65306;https://github.com/w3c/webappsec-feature-policy/blob/master/features.md
    #(3)	&#20351;&#29992;&#31684;&#20363;&#65306;
    #       Feature-Policy: unsized-media 'none'; geolocation 'self' https://example.com; camera *;
    #       &#19981;&#30906;&#23450;Pockii&#38656;&#35201;&#21855;&#29992;&#25110;&#31105;&#29992;&#20160;&#40636;&#21151;&#33021;
    #(4)	&#28687;&#35261;&#22120;&#65306;&#38500;&#20102;Chrome&#36319;Safari&#65292;&#20854;&#20182;&#22823;&#22810;&#19981;&#25903;&#25588;
    # if {![HTTP::header exists "Feature-Policy"] } { 
    #     HTTP::header insert "Feature-Policy" "microphone 'none'" 
    # }

    #6.	Permissions-Policy
    #(1)    &#35498;&#26126;&#65306;2020&#24180;7&#26376;16&#26085;&#65292;w3c&#32068;&#32340;&#37323;&#20986;&#35215;&#31684;&#65292;Feature Policy &#27491;&#24335;&#26356;&#21517;&#28858; Permissions Policy
    #(2)	&#29992;&#36884;&#65306;&#21516;Feature-Policy
    #(3)	Feature-Policy&#36681;&#25563;Permissions-Policy&#23531;&#27861;&#65306;
    #       Feature-Policy: microphone 'none'
    #       Permissions-Policy: microphone=()
    #
    #       Feature-Policy: geolocation 'self' https://example.com; microphone 'none'
    #       Permissions-Policy: geolocation=(self https://example.com), microphone=()
    if {![HTTP::header exists "Permissions-Policy"] } { 
        HTTP::header insert "Permissions-Policy" "camera=(), microphone=(), geolocation=()" 
    }

    #7.	Content-Security-Policy
    #(1)	&#29992;&#36884;&#65306;&#29992;&#30333;&#21517;&#21934;&#30340;&#26041;&#24335;&#65292;&#38480;&#21046;&#32178;&#31449;&#30340;script object style font&#20358;&#28304;&#65292;&#21482;&#26377;&#30333;&#21517;&#21934;&#20839;&#30340;&#36039;&#28304;&#21487;&#20197;&#36617;&#20837;
    #(2)	&#28687;&#35261;&#22120;&#65306;&#22823;&#22810;&#26377;&#25903;&#25588;
    if {![HTTP::header exists "Content-Security-Policy"] } { 
        HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' blob: 'unsafe-inline' 'unsafe-eval' https://*.ctbcbank.com https://www.google.com https://www.google-analytics.com https://ssl.google-analytics.com https://www.googleadservices.com https://googleads.g.doubleclick.net https://*.googletagmanager.com https://tagmanager.google.com https://d.line-scdn.net https://connect.facebook.net ;img-src 'self' data: blob: https://*.ctbcbank.com https://www.google.com https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw https://ssl.gstatic.com https://www.gstatic.com ; frame-src 'self' https://bid.g.doubleclick.net ;connect-src 'self' https://www.google-analytics.com  https://*.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw https://www.shopback.com.tw ;style-src 'self' 'unsafe-inline' https://*.ctbcbank.com https://tagmanager.google.com https://fonts.googleapis.com ; font-src 'self' data: https://*.ctbcbank.com https://fonts.gstatic.com ;"

        #HTTP::header insert "Content-Security-Policy" "default-src 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' blob: 'unsafe-inline' 'unsafe-eval' https://*.ctbcbank.com https://www.google.com https://www.google-analytics.com https://ssl.google-analytics.com https://www.googleadservices.com https://googleads.g.doubleclick.net https://*.googletagmanager.com https://tagmanager.google.com; img-src 'self' data: https://*.ctbcbank.com https://www.google.com https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw https://ssl.gstatic.com https://www.gstatic.com ;  frame-src 'self' https://bid.g.doubleclick.net ; connect-src 'self' https://www.google-analytics.com  https://*.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://*.g.doubleclick.net https://*.google.com https://*.google.com.tw https://www.shopback.com.tw ; style-src 'self' 'unsafe-inline' https://*.ctbcbank.com https://tagmanager.google.com https://fonts.googleapis.com ;  font-src 'self' data: https://*.ctbcbank.com https://fonts.gstatic.com ; "
        #HTTP::header insert "Content-Security-Policy" "default-src https: 'self' data: blob: ; script-src 'self' data: blob: 'unsafe-inline' 'unsafe-eval' https://ap-east-1-02650019-view.menlosecurity.com https://www.googletagmanager.com https://googleads.g.doubleclick.net https://*.menlosecurity.com https://www.google-analytics.com https://*.analytics.google.com https://analytics.google.com https://maxcdn.bootstrapcdn.com https://d.line-scdn.net https://static.addtoany.com https://*.googleapis.com https://track.tamedia.com.tw https://www.googleadservices.com https://tag.yieldoptimizer.com https://connect.facebook.net https://bat.bing.com https://jscdn.appier.net https://js.adsrvr.org; media-src 'self' data: blob: https://*.menlosecurity.com ; object-src 'self'  https://*.menlosecurity.com; img-src 'self' data: blob:  https://www.google.com https://bat.bing.com https://www.facebook.com https://googleads.g.doubleclick.net https://*.ctbcbank.com https://*.menlosecurity.com https://www.googletagmanager.com https://www.google-analytics.com https://*.analytics.google.com https://analytics.google.com https://maxcdn.bootstrapcdn.com https://d.line-scdn.net https://static.addtoany.com https://*.googleapis.com ; frame-src 'self' https://www.googletagmanager.com https://*.menlosecurity.com https://safe.menlosecurity.com https://bid.g.doubleclick.net/; connect-src 'self' https://anylist.c.appier.net  wss://*.menlosecurity.com  https://www.googletagmanager.com https://www.google-analytics.com https://*.analytics.google.com https://analytics.google.com https://maxcdn.bootstrapcdn.com https://d.line-scdn.net https://static.addtoany.com https://*.googleapis.com https://stats.g.doubleclick.net; style-src 'self' 'unsafe-inline' data: blob: https://*.menlosecurity.com https://www.googletagmanager.com https://www.google-analytics.com https://*.analytics.google.com https://analytics.google.com https://maxcdn.bootstrapcdn.com https://d.line-scdn.net https://static.addtoany.com https://*.googleapis.com https://*.ctbcbank.com; font-src 'self' data: blob: https://*.menlosecurity.com https://www.googletagmanager.com https://www.google-analytics.com https://*.analytics.google.com https://analytics.google.com https://maxcdn.bootstrapcdn.com https://d.line-scdn.net https://static.addtoany.com https://*.googleapis.com https://fonts.gstatic.com; report-uri https://xhr-ap-east-1-02650019-view.menlosecurity.com/safeview-client-logger/csp-violation;"
    }
    #8.	X-Content-Security-Policy for IE 
    if {![HTTP::header exists "X-Content-Security-Policy"] } { 
        HTTP::header insert "X-Content-Security-Policy" "default-src 'self' www.google-analytics.com *.facebook.net *.facebook.com sandbox allow-scripts www.googletagmanager.com *.ctbcbank.com *.googleapis.com *.gstatic.com"  
    }

	#9. Cache-Control
    #&#20462;&#27491;&#40657;&#31665;&#24369;&#40670;
    HTTP::header remove "Cache-Control"
    HTTP::header insert "Cache-Control" "no-store, max-age=0"

}
}
ltm rule /MPB/iRule_mpb_cpcob_REMOVE_RANGE {
when HTTP_REQUEST {
    # remove Range requests for CVE-2011-3192
    HTTP::header remove Range
    HTTP::header remove Request-Range
}
}
ltm rule /MPB/iRule_mpb_cpcob_access_denied {
when RULE_INIT {
    set ::ma_content_mpb_cpcob "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><style></style></head><body lang=ZH-TW style='text-justify-trim:punctuation'><p><b><u>&#37325;&#35201;&#20844;&#21578;</u></b></p><p>&#30446;&#21069;&#27491;&#36914;&#34892;&#31995;&#32113;&#26356;&#26032;&#20013;&#65292;&#36896;&#25104;&#19981;&#20415;&#65292;&#25964;&#35531;&#35211;&#35538;!</p><p>&nbsp;</p><p>&#20013;&#22283;&#20449;&#35351; &#25964;&#21855;</p></body></html>"
}

when HTTP_REQUEST {
    #&#21508;&#26381;&#21209;&#28165;sys-params cache&#36335;&#24465;
    if { [HTTP::uri] starts_with "/api/cleanObSystemParamsCache" }
    {
        HTTP::redirect "https://[HTTP::host]/cpc/#"
    }
    #&#22810;&#37666;&#21253;&#28165;&#38651;&#25991;&#28165;&#21934;cache&#36335;&#24465;
	if { [HTTP::has_responded] } { return };
    if { [HTTP::uri] starts_with "/api/cleanObTeleResultMappingCache" }
    { 
        HTTP::redirect "https://[HTTP::host]/cpc/#"
    }
}
}
ltm rule /MPB/iRule_mpb_cpcob_dispatch_setCookie_HTTP_HTTPS_only {
when HTTP_RESPONSE {

   set allcookie [HTTP::header values "Set-Cookie"]
   HTTP::header remove "Set-Cookie"

   foreach thecookie $allcookie {
      if {$thecookie starts_with "result" || $thecookie starts_with "rsid" || $thecookie starts_with "XSRF-TOKEN" } {
         HTTP::header insert "Set-Cookie" "$thecookie"
      } 
      else {
         HTTP::header insert "Set-Cookie" "${thecookie}; secure; HttpOnly"
      }
   }
}
}
ltm rule /MPB/iRule_mpb_cpcob_http_https {
when HTTP_REQUEST {
HTTP::redirect "https://[HTTP::host][HTTP::uri]"
}
}
ltm snat-translation /MPB/10.23.91.38 {
    address 10.23.91.38
    inherited-traffic-group true
    traffic-group /Common/traffic-group-1
}
ltm snatpool /MPB/MPB_F5_DMZ_SNAT {
    members {
        /MPB/10.23.91.38
    }
}
ltm virtual /MPB/VS_MPB_F5_DMZ {
    destination /Common/175.184.243.10:9443
    ip-protocol tcp
    last-modified-time 2023-04-14:06:46:56
    mask 255.255.255.255
    policies {
        /MPB/asm_auto_l7_policy__VS_MPB_F5_DMZ { }
    }
    pool /MPB/POOL_MPB
    profiles {
        /Common/MPB_SSL_P {
            context clientside
        }
        /Common/http2 { }
        /Common/serverssl-insecure-compatible {
            context serverside
        }
        /Common/tcp { }
        /Common/websecurity { }
        /MPB/ASM_SP_MPB { }
        /MPB/HTTP_X_forward { }
    }
    rules {
        /MPB/iRule_MPB_COOKIE_SECURE
        /MPB/iRule_MPB_Parsing_Online_Request_Data
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /MPB/MPB_F5_DMZ_SNAT
        type snat
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual /MPB/VS_MPB_F5_DMZ_443 {
    destination /Common/175.184.243.10:443
    ip-protocol tcp
    last-modified-time 2023-08-06:00:00:20
    mask 255.255.255.255
    persist {
        /MPB/MPB_PERSIST {
            default yes
        }
    }
    policies {
        /MPB/asm_auto_l7_policy__VS_MPB_F5_DMZ_443 { }
    }
    pool /MPB/POOL_MPB_EM_WEB_18066
    profiles {
        /Common/MPB_SSL_P {
            context clientside
        }
        /Common/http2 { }
        /Common/tcp { }
        /Common/websecurity { }
        /MPB/ASM_SP_MPB { }
        /MPB/HTTP_X_forward_MPB_EM { }
    }
    rules {
        /MPB/iRule_MPB_COOKIE_SECURE
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /MPB/MPB_F5_DMZ_SNAT
        type snat
    }
    translate-address enabled
    translate-port enabled
    vlans {
        /Common/DMZ_Vlan_2794
    }
    vlans-enabled
}
ltm virtual /MPB/VS_MPB_WEB_9080 {
    destination /Common/175.184.243.10:9080
    ip-protocol tcp
    mask 255.255.255.255
    policies {
        /MPB/asm_auto_l7_policy__VS_MPB_WEB_9080 { }
    }
    pool /MPB/POOL_MPB
    profiles {
        /Common/HTTP_X_forward { }
        /Common/serverssl-insecure-compatible {
            context serverside
        }
        /Common/tcp { }
        /Common/websecurity { }
        /MPB/ASM_SP_MPB { }
    }
    rules {
        /MPB/iRule_MPB_COOKIE_SECURE
    }
    security-log-profiles {
        /Common/Arcsight_LOG_P
        /Common/Arcsight_LOG_P_local
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /MPB/MPB_F5_DMZ_SNAT
        type snat
    }
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /MPB/10.24.106.7 {
    address 10.24.106.7
    arp enabled
    icmp-echo enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}
ltm data-group internal /MPB/MPB_AP_SERVER_IP {
    records {
        10.23.40.152 { }
        10.23.40.153 { }
    }
    type string
}
ltm data-group internal /MPB/MPB_FILTER_APIUSERID {
    records {
        \"ApiUserId\":\"0130700076\" { }
        \"ApiUserId\":\"Carrefour\" { }
        \"ApiUserId\":\"Cosmed_CTBC_0\" { }
        \"ApiUserId\":\"Cosmed_CTBC_1\" { }
        \"ApiUserId\":\"Cosmed_CTBC_2\" { }
        \"ApiUserId\":\"Cosmed_CTBC_3\" { }
        \"ApiUserId\":\"Cosmed_CTBC_4\" { }
        \"ApiUserId\":\"OKMart\" { }
        \"ApiUserId\":\"OKmini\" { }
    }
    type string
}
ltm data-group internal /MPB/MPB_FILTER_STORE {
    records {
        \"StoreId\":\"144795\" { }
    }
    type string
}
ltm data-group internal /MPB/MPB_POOL_CONTROL {
    records {
        IS_MAINTAIN {
            data N
        }
        POOL_NUM {
            data 1
        }
    }
    type string
}
ltm monitor http /MPB/test_slb {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 5
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /opm HTTP/1.0"
    time-until-up 0
    timeout 16
}
ltm monitor https /MPB/MPB_WEB_MONITOR {
    adaptive disabled
    cipherlist DEFAULT:+SHA:+3DES:+kEDH
    compatibility enabled
    defaults-from /Common/https
    destination *:*
    interval 33
    ip-dscp 0
    recv alive
    recv-disable none
    send "POST /mvc/f5Monitor/queryDBHealth HTTP/1.1\r\nHost: 175.184.243.10\r\nUser-Agent: Mozilla/4.0 (compatible; Mozilla/4.0; F5)\r\nConnection:Close\r\n\r\n\r\n"
    time-until-up 0
    timeout 100
}
ltm persistence cookie /MPB/cookie_insert_mpb_cpcob {
    app-service none
    cookie-encryption required
    cookie-encryption-passphrase $M$Sx$Ck3ynDGAmYhb/6DSzPGiBA==
    defaults-from /Common/cookie
}
ltm persistence universal /MPB/MPB_PERSIST {
    app-service none
    defaults-from /Common/universal
    rule /MPB/MPB_PERSIST
}
ltm profile client-ssl /MPB/MPB_CPCOB_SSL {
    app-service none
    cert /MPB/MPB_CPCOB_SSL_2023
    cert-key-chain {
        MPB_CPCOB_SSL_2023_MPB_CPCOB_SSL_2023_UCA_0 {
            cert /MPB/MPB_CPCOB_SSL_2023
            chain /MPB/MPB_CPCOB_SSL_2023_UCA
            key /MPB/MPB_CPCOB_SSL_2023
        }
    }
    chain /MPB/MPB_CPCOB_SSL_2023_UCA
    cipher-group none
    ciphers ECDHE:!3DES:!SHA1:!CHACHA20-POLY1305:!AES
    defaults-from /Common/clientssl
    inherit-ca-certkeychain true
    inherit-certkeychain false
    key /MPB/MPB_CPCOB_SSL_2023
    options { dont-insert-empty-fragments no-tlsv1.3 no-tlsv1.1 no-sslv3 no-tlsv1 }
    passphrase none
}
ltm profile client-ssl /MPB/MPB_SSL_P_All {
    app-service none
    cert-key-chain {
        MPB_SSL_2022_MPB_SSL_2022_CHAIN_0 {
            cert /Common/MPB_SSL_2022.crt
            chain /Common/MPB_SSL_2022_CHAIN.crt
            key /Common/MPB_SSL_2022.key
        }
    }
    cipher-group none
    ciphers ALL
    defaults-from /Common/clientssl
    inherit-ca-certkeychain true
    inherit-certkeychain false
    renegotiation disabled
}
ltm profile http /MPB/HTTP_X_forward {
    accept-xff disabled
    app-service none
    defaults-from /Common/http
    encrypt-cookies none
    enforcement {
        known-methods { GET POST }
        max-header-count 64
        max-header-size 32768
        max-requests 0
        pipeline allow
        truncated-redirects disabled
        unknown-method reject
    }
    fallback-host none
    fallback-status-codes none
    header-erase none
    header-insert none
    insert-xforwarded-for disabled
    lws-separator none
    lws-width 80
    oneconnect-transformations enabled
    proxy-type reverse
    redirect-rewrite none
    request-chunking sustain
    response-chunking sustain
    response-headers-permitted none
    server-agent-name none
    sflow {
        poll-interval 0
        poll-interval-global yes
        sampling-rate 0
        sampling-rate-global yes
    }
    via-request preserve
    via-response preserve
    xff-alternative-names none
}
ltm profile http /MPB/HTTP_X_forward_MPB_EM {
    accept-xff disabled
    app-service none
    defaults-from /Common/http
    encrypt-cookies none
    enforcement {
        max-header-count 64
        max-header-size 32768
        max-requests 0
        pipeline allow
        truncated-redirects disabled
        unknown-method allow
    }
    fallback-host none
    fallback-status-codes none
    header-erase none
    header-insert X-Forwarded-Proto:https
    insert-xforwarded-for enabled
    lws-separator none
    lws-width 80
    oneconnect-transformations enabled
    proxy-type reverse
    request-chunking sustain
    response-chunking sustain
    response-headers-permitted none
    server-agent-name none
    sflow {
        poll-interval 0
        poll-interval-global no
        sampling-rate 0
        sampling-rate-global no
    }
    via-request preserve
    via-response preserve
    xff-alternative-names none
}
ltm profile server-ssl /MPB/MPB_WEB_MONITOR_ssl_profile {
    app-service none
    cert none
    cipher-group none
    ciphers DEFAULT:+SHA:+3DES
    defaults-from /Common/serverssl
    key none
    options { dont-insert-empty-fragments no-tlsv1.3 }
}
security bot-defense asm-profile /MPB/ASM_SP_MPB {
    app-service none
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2019.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2019.crt_78879_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2019_ROOT.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2019_ROOT.crt_78886_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2019_UCA_1.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2019_UCA_1.crt_78893_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2019_UCA_2.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2019_UCA_2.crt_78900_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2020.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2020.crt_78632_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2021.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2021.crt_89370_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2022.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2022.crt_170118_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2022_ROOT.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2022_ROOT.crt_170136_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2022_UCA.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2022_UCA.crt_170127_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2023 {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2023_104348_1
    revision 1
}
sys file ssl-cert /MPB/MPB_CPCOB_SSL_2023_UCA {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_CPCOB_SSL_2023_UCA_104365_1
    revision 1
}
sys file ssl-cert /MPB/MPB_SSL_2020.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_SSL_2020.crt_78644_1
    revision 1
}
sys file ssl-cert /MPB/MPB_SSL_2021.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_SSL_2021.crt_90220_1
    revision 1
}
sys file ssl-cert /MPB/MPB_SSL_2021_CHAIN.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:MPB_SSL_2021_CHAIN.crt_90231_1
    revision 1
}
sys file ssl-cert /MPB/Symantec_Intermediate_chain_G3.crt {
    cache-path /config/filestore/files_d/MPB_d/certificate_d/:MPB:Symantec_Intermediate_chain_G3.crt_40571_1
    revision 1
}
sys file ssl-key /MPB/MPB_CPCOB_SSL_2019.key {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_CPCOB_SSL_2019.key_78907_1
    revision 1
}
sys file ssl-key /MPB/MPB_CPCOB_SSL_2020.key {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_CPCOB_SSL_2020.key_78628_1
    revision 1
}
sys file ssl-key /MPB/MPB_CPCOB_SSL_2021.key {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_CPCOB_SSL_2021.key_89366_1
    revision 1
}
sys file ssl-key /MPB/MPB_CPCOB_SSL_2022.key {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_CPCOB_SSL_2022.key_170145_1
    revision 1
}
sys file ssl-key /MPB/MPB_CPCOB_SSL_2023 {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_CPCOB_SSL_2023_104344_1
    revision 1
}
sys file ssl-key /MPB/MPB_SSL_2020.key {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_SSL_2020.key_78640_1
    revision 1
}
sys file ssl-key /MPB/MPB_SSL_2021.key {
    cache-path /config/filestore/files_d/MPB_d/certificate_key_d/:MPB:MPB_SSL_2021.key_90227_1
    revision 1
}
